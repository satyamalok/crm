<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Assignment CRM</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        /* Global styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: #212529;
            line-height: 1.5;
            padding-bottom: 2rem;
        }
        
        .navbar {
            background-color: #4361ee;
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .navbar-title {
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        .navbar-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .agent-display {
            display: none;  /* Will be shown when logged in */
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .section-tabs {
            display: flex;
            overflow-x: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .section-tab {
            padding: 1rem;
            cursor: pointer;
            white-space: nowrap;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .section-tab.active {
            color: #4361ee;
            border-bottom: 2px solid #4361ee;
            font-weight: 500;
        }
        
        .section-tab:hover:not(.active) {
            color: #4361ee;
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .crm-section {
            display: none;
        }
        
        .crm-section.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .navbar-title {
                font-size: 1rem;
            }
            
            .section-tab {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-title">Lead Assignment CRM</div>
            <div class="navbar-info">
                <div class="agent-display">
                    <span class="agent-code-display"></span> | <span class="agent-name-display"></span>
                </div>
                <button id="navLogoutBtn" class="logout-btn">Logout</button>
            </div>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Section Tabs (only visible when logged in) -->
        <div id="sectionTabs" class="section-tabs" style="display: none;">
            <div class="section-tab active" data-section="lead-management">Lead Management</div>
            <div class="section-tab" data-section="not-my-lead">Not My Lead</div>
            <div class="section-tab" data-section="my-client-details">My Client Details</div>
            <div class="section-tab" data-section="check-individual-lead">Check Individual Lead</div>
        </div>
        
        <!-- CRM Sections -->
        <div id="agentSelectionSection" class="crm-section active">
            <!-- Agent Selection Component will be inserted here -->
            
            <!-- Agent Selection Component -->
<div class="crm-container agent-selection-container">
    <div class="crm-card">
        <div class="crm-card-header">
            <h2>Agent Login</h2>
        </div>
        <div class="crm-card-body">
            <div class="form-group">
                <label for="agentCode">Select Agent Code:</label>
                <select id="agentCode" class="form-control">
                    <option value="" disabled selected>Select your agent code</option>
                    <option value="Agent 1">Agent 1</option>
                    <option value="Agent 2">Agent 2</option>
                    <option value="Agent 3">Agent 3</option>
                    <option value="Agent 4">Agent 4</option>
                    <option value="Agent 5">Agent 5</option>
                    <option value="Agent 6">Agent 6</option>
                    <option value="Agent 7">Agent 7</option>
                    <option value="Agent 8">Agent 8</option>
                    <option value="Agent 9">Agent 9</option>
                    <option value="Agent 10">Agent 10</option>
                    <option value="Agent 11">Agent 11</option>
                    <option value="Agent 12">Agent 12</option>
                </select>
            </div>
            <div class="form-group">
                <label for="agentName">Enter Your Name:</label>
                <input type="text" id="agentName" class="form-control" placeholder="Enter your name">
            </div>
            <button id="loginButton" class="btn btn-primary btn-block">Continue to Lead Management</button>
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #4361ee;
    --secondary-color: #3f37c9;
    --accent-color: #4895ef;
    --success-color: #4cc9f0;
    --danger-color: #f72585;
    --warning-color: #f8961e;
    --light-color: #f8f9fa;
    --dark-color: #212529;
    --gray-color: #6c757d;
    --light-gray: #e9ecef;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

.crm-container {
    font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem;
    color: var(--dark-color);
}

.agent-selection-container {
    max-width: 500px;
    margin: 2rem auto;
}

.crm-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    margin-bottom: 1rem;
}

.crm-card-header {
    background-color: var(--primary-color);
    color: white;
    padding: 1rem;
    text-align: center;
}

.crm-card-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 500;
}

.crm-card-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--dark-color);
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    background-color: white;
    transition: var(--transition);
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.25);
}

.btn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: var(--border-radius);
    transition: var(--transition);
    cursor: pointer;
}

.btn-primary {
    color: white;
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
}

.btn-block {
    display: block;
    width: 100%;
}

@media (max-width: 576px) {
    .agent-selection-container {
        margin: 1rem auto;
    }
    
    .crm-card-header h2 {
        font-size: 1.25rem;
    }
    
    .crm-card-body {
        padding: 1rem;
    }
    
    .form-control, .btn {
        font-size: 0.9rem;
        padding: 0.6rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if agent info exists in localStorage
    const storedAgentCode = localStorage.getItem('agentCode');
    const storedAgentName = localStorage.getItem('agentName');
    
    // If agent info exists, pre-fill the form
    if (storedAgentCode && storedAgentName) {
        document.getElementById('agentCode').value = storedAgentCode;
        document.getElementById('agentName').value = storedAgentName;
    }
    
    // Handle login button click
    document.getElementById('loginButton').addEventListener('click', function() {
        const agentCode = document.getElementById('agentCode').value;
        const agentName = document.getElementById('agentName').value;
        
        // Validate inputs
        if (!agentCode) {
            alert('Please select your Agent Code');
            return;
        }
        
        if (!agentName || agentName.trim() === '') {
            alert('Please enter your name');
            return;
        }
        
        // Save to localStorage
        localStorage.setItem('agentCode', agentCode);
        localStorage.setItem('agentName', agentName);
        
        // Get agent number from agent code for API calls
        const agentNumber = agentCode.replace('Agent ', '');
        localStorage.setItem('agentNumber', agentNumber);
        
        // Set agent name for display in other sections
        const agentNameDisplay = document.querySelectorAll('.agent-name-display');
        agentNameDisplay.forEach(element => {
            element.textContent = agentName;
        });
        
        // Set agent code for display in other sections
        const agentCodeDisplay = document.querySelectorAll('.agent-code-display');
        agentCodeDisplay.forEach(element => {
            element.textContent = agentCode;
        });
        
        // Hide this section and show the lead management section
        document.querySelector('.agent-selection-container').style.display = 'none';
        
        // Show the lead management container (will be implemented next)
        const leadManagementContainer = document.querySelector('.lead-management-container');
        if (leadManagementContainer) {
            leadManagementContainer.style.display = 'block';
        } else {
            console.log('Lead management container not found');
        }
        
        // Event for other parts of the app to know login is complete
        document.dispatchEvent(new CustomEvent('agentLoggedIn', {
            detail: { agentCode, agentName, agentNumber }
        }));
    });
    
    // Clear localStorage on logout (will be used in other sections)
    window.logoutAgent = function() {
        localStorage.removeItem('agentCode');
        localStorage.removeItem('agentName');
        localStorage.removeItem('agentNumber');
        
        // Reload the page to reset the app state
        window.location.reload();
    };
});
</script>
        </div>
        
        <div id="leadManagementSection" class="crm-section">
            <!-- Lead Management Component will be inserted here -->
      
<!-- Lead Management Component (Complete) -->
<div class="crm-container lead-management-container" style="display: none;">
    <div class="crm-card">
        <div class="crm-card-header">
            <h2>Lead Management</h2>
            <div class="agent-info">
                <p><span class="agent-code-display"></span> | <span class="agent-name-display"></span></p>
                <button id="logoutButton" class="btn btn-sm btn-outline">Logout</button>
            </div>
        </div>
        <div class="crm-card-body">
            <button id="getLeadButton" class="btn btn-primary btn-block">Get New Lead</button>
            
            <div id="leadDetailsContainer" class="lead-details-container" style="display: none;">
                <div class="lead-loading" id="leadLoading">
                    <div class="spinner"></div>
                    <p>Loading lead information...</p>
                </div>
                
                <div id="leadCardContainer" class="lead-card-container">
                    <!-- Lead cards will be dynamically inserted here -->
                </div>
                
                <div class="lead-action-container">
                    <div class="lead-action-buttons">
                        <a id="callButton" href="#" class="btn btn-success">
                            <i class="fas fa-phone"></i> Call
                        </a>
                        <a id="whatsappButton" href="#" class="btn btn-success">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadNotes">Notes:</label>
                        <textarea id="leadNotes" class="form-control" rows="3" placeholder="Add notes about this lead..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadStage">Disposition Stage:</label>
                        <select id="leadStage" class="form-control">
                            <option value="" disabled selected>Select disposition</option>
                            <option value="No Response">No Response</option>
                            <option value="Not Interested">Not Interested</option>
                            <option value="App Pending">App Pending</option>
                            <option value="App Done">App Done</option>
                            <option value="Call Later">Call Later</option>
                            <option value="Trial Enrolled">Trial Enrolled</option>
                            <option value="Trial Attended">Trial Attended</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    
                    <!-- Call Later date picker (hidden by default) -->
                    <div id="callLaterDateContainer" class="form-group" style="display: none;">
                        <label for="callLaterDate">Select Call Back Date:</label>
                        <input type="date" id="callLaterDate" class="form-control">
                    </div>
                    
                    <!-- Trial Attended duration picker (hidden by default) -->
                    <div id="trialDurationContainer" class="form-group" style="display: none;">
                        <label>Select Trial Duration:</label>
                        <div class="duration-picker">
                            <div class="duration-field">
                                <input type="number" id="durationHours" class="form-control" min="0" max="23" value="0">
                                <label>Hours</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="durationMinutes" class="form-control" min="0" max="59" value="0">
                                <label>Minutes</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="durationSeconds" class="form-control" min="0" max="59" value="0">
                                <label>Seconds</label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="submitLeadButton" class="btn btn-primary btn-block">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Extending the existing styles */
.lead-management-container {
    max-width: 800px;
}

.agent-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: var(--border-radius);
}

.btn-outline {
    color: white;
    background-color: transparent;
    border: 1px solid white;
}

.btn-outline:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.btn-success {
    color: white;
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.btn-success:hover {
    background-color: #3db8dc;
    border-color: #3db8dc;
}

.lead-details-container {
    margin-top: 1.5rem;
}

.lead-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.lead-card-container {
    margin: 1.5rem 0;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.lead-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
}

.lead-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.lead-card-title {
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
}

.lead-card-date {
    color: var(--gray-color);
    font-size: 0.9rem;
}

.lead-card-content {
    margin-bottom: 0.5rem;
}

.lead-card-content p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
}

.lead-card-label {
    font-weight: 500;
    color: var(--gray-color);
}

.lead-action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.lead-action-buttons .btn {
    flex: 1;
}

.duration-picker {
    display: flex;
    gap: 0.5rem;
}

.duration-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.duration-field label {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

#submitLeadButton {
    margin-top: 1.5rem;
}

@media (max-width: 576px) {
    .lead-action-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .duration-picker {
        flex-direction: column;
        gap: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs
    const TABLE_IDS = {
        'main': 'mxrl7syu0qe3xu3',
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37',
        // Add your actual IDs for these tables
        'noResponse': 'no_response_table_id',
        'notInterested': 'not_interested_table_id'
    };
    
    // n8n Webhook URLs - Replace with your actual webhook URLs
    const WEBHOOKS = {
        'no_response': 'https://your-n8n-instance.com/webhook/no-response',
        'not_interested': 'https://your-n8n-instance.com/webhook/not-interested'
    };
    
    // View IDs (from your provided API calls)
    const VIEW_IDS = {
        'main': 'vw1w37kpbvbibe8p',
        'Agent 1': 'vw6qsy9bhjjmp2uj',
        'Agent 2': 'vwkbmwz2s27sfmaf',
        'Agent 3': 'vwinp2ry3tsgs05v',
        'Agent 4': 'vw1pfyodq1rue5qa',
        'Agent 5': 'vwm662zy0mgsa6sz',
        'Agent 6': 'vwg9aurks8a990r4',
        'Agent 7': 'vwd1mneqgdxgxsyp',
        'Agent 8': 'vwgnatfcc29lnwxe',
        'Agent 9': 'vw7svg5hmw7ynq5t',
        'Agent 10': 'vwy47pqclq52v8o0',
        'Agent 11': 'vwfv3a57j5pe6d66',
        'Agent 12': 'vw3n15cpn8oazt71'
    };
    
    // Global variables
    let currentLead = null;
    
    // DOM Elements
    const getLeadButton = document.getElementById('getLeadButton');
    const leadDetailsContainer = document.getElementById('leadDetailsContainer');
    const leadLoading = document.getElementById('leadLoading');
    const leadCardContainer = document.getElementById('leadCardContainer');
    const callButton = document.getElementById('callButton');
    const whatsappButton = document.getElementById('whatsappButton');
    const leadNotes = document.getElementById('leadNotes');
    const leadStage = document.getElementById('leadStage');
    const callLaterDateContainer = document.getElementById('callLaterDateContainer');
    const callLaterDate = document.getElementById('callLaterDate');
    const trialDurationContainer = document.getElementById('trialDurationContainer');
    const durationHours = document.getElementById('durationHours');
    const durationMinutes = document.getElementById('durationMinutes');
    const durationSeconds = document.getElementById('durationSeconds');
    const submitLeadButton = document.getElementById('submitLeadButton');
    const logoutButton = document.getElementById('logoutButton');
    
    // Set today as min date for call later
    const today = new Date().toISOString().split('T')[0];
    callLaterDate.min = today;
    
    // Display agent info from localStorage
    function displayAgentInfo() {
        const agentCode = localStorage.getItem('agentCode');
        const agentName = localStorage.getItem('agentName');
        
        if (agentCode && agentName) {
            document.querySelectorAll('.agent-code-display').forEach(el => {
                el.textContent = agentCode;
            });
            
            document.querySelectorAll('.agent-name-display').forEach(el => {
                el.textContent = agentName;
            });
        }
    }
    
    // Initialize the component
    function initLeadManagement() {
        displayAgentInfo();
        
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        const agentName = localStorage.getItem('agentName');
        
        if (!agentCode || !agentName) {
            // If not logged in, make sure this section is hidden
            document.querySelector('.lead-management-container').style.display = 'none';
            return;
        }
        
        // If logged in, show this section
        document.querySelector('.lead-management-container').style.display = 'block';
    }
    
    // Event listener for logout button
    logoutButton.addEventListener('click', function() {
        window.logoutAgent();
    });
    
    // Event listener for get lead button
    getLeadButton.addEventListener('click', function() {
        getNewLead();
    });
    
    // Handle lead stage select change
    leadStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle visibility of call later date picker
        if (selectedStage === 'Call Later') {
            callLaterDateContainer.style.display = 'block';
        } else {
            callLaterDateContainer.style.display = 'none';
        }
        
        // Toggle visibility of trial duration picker
        if (selectedStage === 'Trial Attended') {
            trialDurationContainer.style.display = 'block';
        } else {
            trialDurationContainer.style.display = 'none';
        }
        
        // Require notes for Not Interested
        if (selectedStage === 'Not Interested') {
            leadNotes.setAttribute('required', 'required');
            leadNotes.placeholder = 'Notes are required for Not Interested status...';
        } else {
            leadNotes.removeAttribute('required');
            leadNotes.placeholder = 'Add notes about this lead...';
        }
    });
    
    // Handle submit lead button
    submitLeadButton.addEventListener('click', function() {
        if (!currentLead) {
            alert('No lead selected');
            return;
        }
        
        const selectedStage = leadStage.value;
        const notes = leadNotes.value;
        
        if (!selectedStage) {
            alert('Please select a disposition stage');
            return;
        }
        
        // Check if notes are required for Not Interested
        if (selectedStage === 'Not Interested' && (!notes || notes.trim() === '')) {
            alert('Notes are required for Not Interested status');
            return;
        }
        
        // Check if date is selected for Call Later
        if (selectedStage === 'Call Later' && !callLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Process lead based on disposition stage
        processLead(selectedStage, notes);
    });
    
    // Get a new lead from the main table
    async function getNewLead() {
        const agentCode = localStorage.getItem('agentCode');
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Show loading and lead details container
        leadDetailsContainer.style.display = 'block';
        leadLoading.style.display = 'flex';
        leadCardContainer.innerHTML = '';
        
        try {
            // 1. Get the newest lead with agent='new'
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/mxrl7syu0qe3xu3/records?where=(Agent,eq,new)&sort=-Id&limit=1`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                leadLoading.style.display = 'none';
                leadCardContainer.innerHTML = `
                    <div class="lead-card">
                        <div class="lead-card-content">
                            <p>No new leads available. Please try again later.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Set current lead
            currentLead = data.list[0];
            const leadPhone = currentLead.Phone;
            
            // Notify other components about the new current lead
            document.dispatchEvent(new CustomEvent('currentLeadUpdated', { 
                detail: { 
                    Phone: leadPhone,
                    Source: currentLead.Source || '',
                    Id: currentLead.Id
                } 
            }));
            
            // 2. Update the lead with agent name
            const agentName = localStorage.getItem('agentName');
            await updateLeadAgent(currentLead.Id, agentCode.toLowerCase().replace(' ', ''));
            
            // 3. Get all lead history with this phone number
            await getLeadHistory(leadPhone);
            
        } catch (error) {
            console.error('Error getting lead:', error);
            leadLoading.style.display = 'none';
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>Error getting lead: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Update lead agent in main table
    async function updateLeadAgent(leadId, agentName) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/mxrl7syu0qe3xu3/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify([
                    {
                        Id: leadId.toString(),
                        Agent: agentName
                    }
                ])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update lead agent: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating lead agent:', error);
            throw error;
        }
    }
    
    // Get lead history by phone number
    async function getLeadHistory(phone) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/mxrl7syu0qe3xu3/records?where=(Phone,eq,${phone})&sort=-Id`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead history: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Hide loading
            leadLoading.style.display = 'none';
            
            // Display lead cards
            displayLeadCards(data.list, phone);
            
        } catch (error) {
            console.error('Error getting lead history:', error);
            leadLoading.style.display = 'none';
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>Error getting lead history: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Display lead cards from history
    function displayLeadCards(leads, phone) {
        if (!leads || leads.length === 0) {
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>No lead history found.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Clear card container
        leadCardContainer.innerHTML = '';
        
        // Add each lead as a card
        leads.forEach(lead => {
            const card = document.createElement('div');
            card.className = 'lead-card';
            card.innerHTML = `
                <div class="lead-card-header">
                    <h3 class="lead-card-title">${lead.Source || 'Unknown Source'}</h3>
                    <span class="lead-card-date">${lead.Date || ''} ${lead.Time || ''}</span>
                </div>
                <div class="lead-card-content">
                    <p><span class="lead-card-label">Phone:</span> ${lead.Phone || phone}</p>
                    ${lead.Agent && lead.Agent !== 'new' ? `<p><span class="lead-card-label">Agent:</span> ${lead.Agent}</p>` : ''}
                </div>
            `;
            
            leadCardContainer.appendChild(card);
        });
        
        // Setup call and whatsapp buttons
        setupActionButtons(phone);
    }
    
    // Setup action buttons for call and whatsapp
    function setupActionButtons(phone) {
        if (!phone) return;
        
        // Set call button href
        callButton.href = `tel:${phone}`;
        
        // Set whatsapp button href (add country code 91 for India)
        whatsappButton.href = `https://wa.me/91${phone}`;
    }
    
    // Process lead based on disposition stage
    async function processLead(stage, notes) {
        if (!currentLead || !currentLead.Phone) {
            alert('Invalid lead data');
            return;
        }
        
        const agentCode = localStorage.getItem('agentCode');
        const agentNumber = localStorage.getItem('agentNumber');
        const phone = currentLead.Phone;
        const date = new Date().toISOString().split('T')[0]; // Today's date
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        try {
            // Show loading
            leadLoading.style.display = 'flex';
            leadCardContainer.style.display = 'none';
            
            // Process based on stage
            switch(stage) {
                case 'No Response':
                    // Add to No Response table
                    await addToNoResponseTable(phone, agentCode);
                    
                    // Send to n8n webhook
                    await sendToWebhook('no_response', phone, agentCode);
                    break;
                    
                case 'Not Interested':
                    // Check for notes
                    if (!notes || notes.trim() === '') {
                        alert('Notes are required for Not Interested status');
                        leadLoading.style.display = 'none';
                        leadCardContainer.style.display = 'block';
                        return;
                    }
                    
                    // Add to Not Interested table
                    await addToNotInterestedTable(phone, agentCode, notes);
                    
                    // Send to n8n webhook
                    await sendToWebhook('not_interested', phone, agentCode, notes);
                    break;
                    
                case 'Call Later':
                    const callbackDate = callLaterDate.value;
                    if (!callbackDate) {
                        alert('Please select a call back date');
                        leadLoading.style.display = 'none';
                        leadCardContainer.style.display = 'block';
                        return;
                    }
                    
                    // Add to agent's table with Call Later stage and callback date
                    await addToAgentTable(phone, stage, notes, callbackDate);
                    break;
                    
                case 'Trial Attended':
                    const hours = parseInt(durationHours.value) || 0;
                    const minutes = parseInt(durationMinutes.value) || 0;
                    const seconds = parseInt(durationSeconds.value) || 0;
                    
                    // Format duration as HHhMMmSSs
                    const duration = `${hours}hr${minutes}min${seconds}sec`;
                    
                    // Add to agent's table with Trial Attended stage and duration
                    await addToAgentTable(phone, stage, notes, null, duration);
                    break;
                    
                default:
                    // For all other stages, just add to agent's table
                    await addToAgentTable(phone, stage, notes);
                    break;
            }
            
            // Reset the form and get a new lead
            resetLeadForm();
            getNewLead();
            
            // Notify other components that the current lead has been processed
            document.dispatchEvent(new CustomEvent('currentLeadProcessed', { 
                detail: { success: true, stage: stage }
            }));
            
        } catch (error) {
            console.error('Error processing lead:', error);
            alert(`Error processing lead: ${error.message}`);
            leadLoading.style.display = 'none';
            leadCardContainer.style.display = 'block';
            
            // Notify of failure
            document.dispatchEvent(new CustomEvent('currentLeadProcessed', { 
                detail: { success: false, error: error.message }
            }));
        }
    }
    
    // Add lead to No Response table
    async function addToNoResponseTable(phone, agentCode) {
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.noResponse}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify({
                    Phone: phone,
                    Agent: agentCode,
                    Date: today,
                    Time: time
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to No Response table: ${response.statusText}`);
            }
            
            console.log('Successfully added to No Response table');
            return true;
        } catch (error) {
            console.error('Error adding to No Response table:', error);
            throw error;
        }
    }
    
    // Add lead to Not Interested table
    async function addToNotInterestedTable(phone, agentCode, notes) {
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.notInterested}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify({
                    Phone: phone,
                    Agent: agentCode,
                    Notes: notes,
                    Date: today,
                    Time: time
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to Not Interested table: ${response.statusText}`);
            }
            
            console.log('Successfully added to Not Interested table');
            return true;
        } catch (error) {
            console.error('Error adding to Not Interested table:', error);
            throw error;
        }
    }
    
    // Add lead to agent's table
    async function addToAgentTable(phone, stage, notes, callbackDate = null, duration = null) {
        const agentCode = localStorage.getItem('agentCode');
        const agentTableId = TABLE_IDS[agentCode];
        
        if (!agentTableId) {
            throw new Error(`Table ID not found for ${agentCode}`);
        }
        
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        // Prepare data to add to agent's table
        const data = {
            Phone: phone,
            Date: callbackDate || today,
            Time: time,
            Notes: notes || '',
            "Lead Stage": stage
        };
        
        // Add source if available
        if (currentLead && currentLead.Source) {
            data.Source = currentLead.Source;
        }
        
        // Add duration if provided (for Trial Attended)
        if (duration) {
            data.Duration = duration;
        }
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${agentTableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to agent table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to agent table:', error);
            throw error;
        }
    }
    
    // Send data to n8n webhook
    async function sendToWebhook(type, phone, agentCode, notes = '') {
        const webhookUrl = WEBHOOKS[type];
        
        if (!webhookUrl) {
            console.warn(`No webhook URL defined for type: ${type}`);
            return false;
        }
        
        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phone,
                    agent: agentCode,
                    notes: notes,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to send to webhook: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error(`Error sending to ${type} webhook:`, error);
            // Don't throw here - we don't want to fail the whole process if webhook fails
            return false;
        }
    }
    
    // Reset lead form
    function resetLeadForm() {
        leadNotes.value = '';
        leadStage.value = '';
        callLaterDate.value = '';
        durationHours.value = '0';
        durationMinutes.value = '0';
        durationSeconds.value = '0';
        callLaterDateContainer.style.display = 'none';
        trialDurationContainer.style.display = 'none';
        
        // Update current lead reference and notify other components
        currentLead = null;
        document.dispatchEvent(new CustomEvent('currentLeadUpdated', { detail: null }));
    }
    
    // Add event listener for current lead request from other components
    document.addEventListener('requestCurrentLead', function() {
        if (currentLead) {
            document.dispatchEvent(new CustomEvent('currentLeadUpdated', { 
                detail: { 
                    Phone: currentLead.Phone,
                    Source: currentLead.Source || '',
                    Id: currentLead.Id
                } 
            }));
        } else {
            document.dispatchEvent(new CustomEvent('currentLeadUpdated', { detail: null }));
        }
    });
    
    // Event listener for resetLeadFormRequested
    document.addEventListener('resetLeadFormRequested', function() {
        resetLeadForm();
    });
    
    // Initialize the component
    document.addEventListener('agentLoggedIn', initLeadManagement);
    
    // Also listen for getNewLeadRequested event (from other components)
    document.addEventListener('getNewLeadRequested', function() {
        if (getLeadButton) {
            getLeadButton.click();
        }
    });
    
    // Also check on DOM content loaded
    initLeadManagement();
});
</script>
            
</div>
        
        <div id="notMyLeadSection" class="crm-section">
            <!-- Not My Lead Component will be inserted here -->
            
            <!-- Not My Lead Component -->
<div class="crm-container not-my-lead-container">
    <div class="crm-card">
        <div class="crm-card-header">
            <h2>Not My Lead</h2>
        </div>
        <div class="crm-card-body">
            <p class="section-description">Use this section when a lead belongs to another agent.</p>
            
            <div class="not-my-lead-form">
                <!-- Only shown when a lead is active -->
                <div id="noActiveLead" class="no-active-lead">
                    <p>You need to get a lead first to transfer it.</p>
                    <p>Go to the Lead Management section and click "Get New Lead".</p>
                </div>
                
                <div id="transferLeadForm" class="transfer-lead-form" style="display: none;">
                    <div class="form-group">
                        <label for="activeLeadPhone">Lead Phone:</label>
                        <input type="text" id="activeLeadPhone" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferToAgent">Transfer To Agent:</label>
                        <select id="transferToAgent" class="form-control">
                            <option value="" disabled selected>Select agent</option>
                            <option value="Agent 1">Agent 1</option>
                            <option value="Agent 2">Agent 2</option>
                            <option value="Agent 3">Agent 3</option>
                            <option value="Agent 4">Agent 4</option>
                            <option value="Agent 5">Agent 5</option>
                            <option value="Agent 6">Agent 6</option>
                            <option value="Agent 7">Agent 7</option>
                            <option value="Agent 8">Agent 8</option>
                            <option value="Agent 9">Agent 9</option>
                            <option value="Agent 10">Agent 10</option>
                            <option value="Agent 11">Agent 11</option>
                            <option value="Agent 12">Agent 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferLeadStage">Lead Stage:</label>
                        <select id="transferLeadStage" class="form-control">
                            <option value="" disabled selected>Select lead stage</option>
                            <option value="Transfer">Transfer</option>
                            <option value="App Done">App Done</option>
                            <option value="Trial Enrolled">Trial Enrolled</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferNotes">Notes:</label>
                        <textarea id="transferNotes" class="form-control" rows="3" placeholder="Add notes about this transfer..."></textarea>
                    </div>
                    
                    <button id="transferLeadButton" class="btn btn-primary btn-block">Transfer Lead</button>
                </div>
                
                <div id="transferLoading" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p>Processing transfer...</p>
                </div>
                
                <div id="transferSuccess" class="success-message" style="display: none;">
                    <div class="success-icon">âœ“</div>
                    <p>Lead successfully transferred!</p>
                    <button id="getNewLeadAfterTransfer" class="btn btn-primary">Get New Lead</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Extending the existing styles */
.not-my-lead-container {
    max-width: 800px;
    margin-top: 2rem;
}

.section-description {
    margin-bottom: 1.5rem;
    color: var(--gray-color);
    font-size: 0.95rem;
}

.no-active-lead {
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
}

.transfer-lead-form {
    margin-top: 1rem;
}

.loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.success-message {
    text-align: center;
    padding: 2rem 0;
}

.success-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--success-color);
    color: white;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

#getNewLeadAfterTransfer {
    margin-top: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs (from your provided API calls)
    const TABLE_IDS = {
        'main': 'mxrl7syu0qe3xu3',
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const noActiveLead = document.getElementById('noActiveLead');
    const transferLeadForm = document.getElementById('transferLeadForm');
    const activeLeadPhone = document.getElementById('activeLeadPhone');
    const transferToAgent = document.getElementById('transferToAgent');
    const transferLeadStage = document.getElementById('transferLeadStage');
    const transferNotes = document.getElementById('transferNotes');
    const transferLeadButton = document.getElementById('transferLeadButton');
    const transferLoading = document.getElementById('transferLoading');
    const transferSuccess = document.getElementById('transferSuccess');
    const getNewLeadAfterTransfer = document.getElementById('getNewLeadAfterTransfer');
    
    // Listen for current lead updates from lead management component
    document.addEventListener('currentLeadUpdated', function(event) {
        const lead = event.detail;
        
        if (lead && lead.Phone) {
            // We have an active lead, show the transfer form
            noActiveLead.style.display = 'none';
            transferLeadForm.style.display = 'block';
            activeLeadPhone.value = lead.Phone;
        } else {
            // No active lead, show the message
            noActiveLead.style.display = 'block';
            transferLeadForm.style.display = 'none';
            activeLeadPhone.value = '';
        }
    });
    
    // Transfer lead button click
    transferLeadButton.addEventListener('click', function() {
        // Validate form
        const phoneNumber = activeLeadPhone.value;
        const targetAgent = transferToAgent.value;
        const leadStage = transferLeadStage.value;
        const notes = transferNotes.value;
        
        if (!phoneNumber) {
            alert('No active lead to transfer');
            return;
        }
        
        if (!targetAgent) {
            alert('Please select an agent to transfer to');
            return;
        }
        
        if (!leadStage) {
            alert('Please select a lead stage');
            return;
        }
        
        // Process the transfer
        transferLead(phoneNumber, targetAgent, leadStage, notes);
    });
    
    // Get new lead after transfer
    getNewLeadAfterTransfer.addEventListener('click', function() {
        // Reset transfer form
        resetTransferForm();
        
        // Trigger get new lead event (for lead management component)
        document.dispatchEvent(new CustomEvent('getNewLeadRequested'));
    });
    
    // Transfer lead to another agent
    async function transferLead(phone, targetAgent, leadStage, notes) {
        const sourceAgent = localStorage.getItem('agentCode');
        const sourceAgentName = localStorage.getItem('agentName');
        
        if (!sourceAgent) {
            alert('Please login first');
            return;
        }
        
        // Show loading
        transferLeadForm.style.display = 'none';
        transferLoading.style.display = 'flex';
        
        try {
            // 1. Update all instances of this phone in the main table with the new agent
            await updateMainTableAgent(phone, targetAgent);
            
            // 2. Add the lead to the target agent's table with the selected stage
            await addToAgentTable(phone, targetAgent, leadStage, notes);
            
            // Show success message
            transferLoading.style.display = 'none';
            transferSuccess.style.display = 'block';
            
            // Notify lead management component that current lead is no longer active
            document.dispatchEvent(new CustomEvent('currentLeadUpdated', { detail: null }));
            
        } catch (error) {
            console.error('Error transferring lead:', error);
            alert(`Error transferring lead: ${error.message}`);
            
            // Hide loading and show form again
            transferLoading.style.display = 'none';
            transferLeadForm.style.display = 'block';
        }
    }
    
    // Update all instances of a phone number in the main table with a new agent
    async function updateMainTableAgent(phone, targetAgent) {
        try {
            // First, get all records with this phone number
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records?where=(Phone,eq,${phone})`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead records: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                return; // No records to update
            }
            
            // Format target agent name for DB (lowercase, no spaces)
            const targetAgentName = targetAgent.toLowerCase().replace(' ', '');
            
            // Prepare update data for all records
            const updateData = data.list.map(record => ({
                Id: record.Id.toString(),
                Agent: targetAgentName
            }));
            
            // Update all records
            const updateResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(updateData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Failed to update lead records: ${updateResponse.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating main table agent:', error);
            throw error;
        }
    }
    
    // Add lead to target agent's table
    async function addToAgentTable(phone, targetAgent, leadStage, notes) {
        // Get target agent's table ID
        const agentTableId = TABLE_IDS[targetAgent];
        
        if (!agentTableId) {
            throw new Error(`Table ID not found for ${targetAgent}`);
        }
        
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        // Get source from active lead if available
        let source = 'Transfer from ' + localStorage.getItem('agentName');
        
        // Check if we can get the original lead's source
        const currentLead = document.getElementById('activeLeadPhone').getAttribute('data-source');
        if (currentLead) {
            source += ' (Original: ' + currentLead + ')';
        }
        
        // Prepare data to add to agent's table
        const data = {
            Phone: phone,
            Date: today,
            Time: time,
            Source: source,
            Notes: notes || '',
            "Lead Stage": leadStage
        };
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${agentTableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to agent table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to agent table:', error);
            throw error;
        }
    }
    
    // Reset transfer form
    function resetTransferForm() {
        activeLeadPhone.value = '';
        transferToAgent.value = '';
        transferLeadStage.value = '';
        transferNotes.value = '';
        transferSuccess.style.display = 'none';
        noActiveLead.style.display = 'block';
    }
    
    // Initialize component
    function initNotMyLead() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.not-my-lead-container').style.display = 'none';
            return;
        }
        
        // Prevent agent from transferring to themselves
        const options = transferToAgent.querySelectorAll('option');
        options.forEach(option => {
            if (option.value === agentCode) {
                option.disabled = true;
            }
        });
        
        // Check for active lead from lead management
        const event = new CustomEvent('requestCurrentLead');
        document.dispatchEvent(event);
    }
    
    // Add event listener for agent login
    document.addEventListener('agentLoggedIn', initNotMyLead);
    
    // Initialize on DOM content loaded
    initNotMyLead();
});
</script>
            
        </div>
        
        <div id="myClientDetailsSection" class="crm-section">
            <!-- My Client Details Component will be inserted here -->
            
            <!-- My Client Details Component -->
<div class="crm-container my-client-details-container">
    <div class="crm-card">
        <div class="crm-card-header">
            <h2>My Client Details</h2>
        </div>
        <div class="crm-card-body">
            <p class="section-description">View and manage your client leads by date and stage.</p>
            
            <div class="client-filter-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientFilterDate">Select Date:</label>
                        <input type="date" id="clientFilterDate" class="form-control">
                    </div>
                    
                    <div class="form-group date-option">
                        <input type="checkbox" id="clientFilterAll" class="form-check-input">
                        <label for="clientFilterAll" class="form-check-label">All Dates</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientFilterStage">Select Lead Stage:</label>
                    <select id="clientFilterStage" class="form-control">
                        <option value="" disabled selected>Select stage</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Transfer">Transfer</option>
                        <option value="App Pending">App Pending</option>
                        <option value="App Done">App Done</option>
                        <option value="Trial Enrolled">Trial Enrolled</option>
                        <option value="Trial Attended">Trial Attended</option>
                        <option value="Call Later">Call Later</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <button id="clientFilterButton" class="btn btn-primary btn-block">View Clients</button>
            </div>
            
            <div id="clientLoading" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Loading client details...</p>
            </div>
            
            <div id="clientResults" class="client-results" style="display: none;">
                <div class="results-header">
                    <h3 id="resultsTitle">Client Results</h3>
                    <span id="resultsCount" class="results-count">0 clients found</span>
                </div>
                
                <div id="clientCardContainer" class="client-card-container">
                    <!-- Client cards will be inserted here dynamically -->
                </div>
                
                <div id="noClientsFound" class="no-results" style="display: none;">
                    <p>No clients found matching your criteria.</p>
                </div>
            </div>
            
            <!-- Client Update Modal -->
            <div id="updateClientModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Update Client</h3>
                        <span id="closeModal" class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="client-info-display">
                            <p><strong>Phone:</strong> <span id="updateClientPhone"></span></p>
                            <p><strong>Current Stage:</strong> <span id="updateClientCurrentStage"></span></p>
                        </div>
                        
                        <div class="form-group">
                            <label for="updateClientStage">New Lead Stage:</label>
                            <select id="updateClientStage" class="form-control">
                                <option value="" disabled selected>Select new stage</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Transfer">Transfer</option>
                                <option value="App Pending">App Pending</option>
                                <option value="App Done">App Done</option>
                                <option value="Trial Enrolled">Trial Enrolled</option>
                                <option value="Trial Attended">Trial Attended</option>
                                <option value="Call Later">Call Later</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                        
                        <!-- Trial Attended duration picker (hidden by default) -->
                        <div id="updateTrialDurationContainer" class="form-group" style="display: none;">
                            <label>Update Trial Duration:</label>
                            <div class="duration-picker">
                                <div class="duration-field">
                                    <input type="number" id="updateDurationHours" class="form-control" min="0" max="23" value="0">
                                    <label>Hours</label>
                                </div>
                                <div class="duration-field">
                                    <input type="number" id="updateDurationMinutes" class="form-control" min="0" max="59" value="0">
                                    <label>Minutes</label>
                                </div>
                                <div class="duration-field">
                                    <input type="number" id="updateDurationSeconds" class="form-control" min="0" max="59" value="0">
                                    <label>Seconds</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call Later date picker (hidden by default) -->
                        <div id="updateCallLaterDateContainer" class="form-group" style="display: none;">
                            <label for="updateCallLaterDate">Select New Call Back Date:</label>
                            <input type="date" id="updateCallLaterDate" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="updateClientNotes">Update Notes:</label>
                            <textarea id="updateClientNotes" class="form-control" rows="3" placeholder="Add or update notes..."></textarea>
                        </div>
                        
                        <button id="updateClientButton" class="btn btn-primary btn-block">Update Client</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Extending the existing styles */
.my-client-details-container {
    max-width: 800px;
    margin-top: 2rem;
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -0.5rem;
    margin-left: -0.5rem;
    align-items: flex-end;
}

.form-row > .form-group {
    flex: 1;
    padding: 0 0.5rem;
    min-width: 200px;
}

.date-option {
    display: flex;
    align-items: center;
    min-width: auto !important;
    margin-top: 1.5rem;
}

.form-check-input {
    margin-right: 0.5rem;
}

.form-check-label {
    margin-bottom: 0;
    cursor: pointer;
}

.client-filter-form {
    margin-bottom: 1.5rem;
}

.loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.results-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.results-count {
    color: var(--gray-color);
    font-size: 0.9rem;
}

.client-card-container {
    margin: 1rem 0;
    max-height: 500px;
    overflow-y: auto;
}

.client-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
}

.client-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.client-card-title {
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
}

.client-card-stage {
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-size: 0.8rem;
    color: white;
    background-color: var(--primary-color);
}

.stage-app-pending { background-color: var(--warning-color); }
.stage-app-done { background-color: var(--accent-color); }
.stage-trial-enrolled { background-color: var(--primary-color); }
.stage-trial-attended { background-color: var(--success-color); }
.stage-paid { background-color: #28a745; } /* Green for paid */
.stage-call-later { background-color: var(--gray-color); }
.stage-transfer { background-color: #17a2b8; } /* Teal for transfer */
.stage-whatsapp { background-color: #25D366; } /* WhatsApp green */

.client-card-content {
    margin-bottom: 0.5rem;
}

.client-card-content p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
}

.client-card-label {
    font-weight: 500;
    color: var(--gray-color);
}

.client-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.no-results {
    text-align: center;
    padding: 2rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
}

/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    width: 90%;
    max-width: 500px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: var(--primary-color);
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.close-modal {
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
}

.modal-body {
    padding: 1.5rem;
}

.client-info-display {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
}

.client-info-display p {
    margin: 0.25rem 0;
}

#updateClientButton {
    margin-top: 1rem;
}

@media (max-width: 576px) {
    .form-row {
        flex-direction: column;
    }
    
    .form-row > .form-group {
        width: 100%;
        padding: 0;
    }
    
    .date-option {
        margin-top: 0.5rem;
    }
    
    .client-card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .client-card-stage {
        margin-top: 0.5rem;
    }
    
    .client-card-actions {
        flex-direction: column;
    }
    
    .client-card-actions .btn {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs (from your provided API calls)
    const TABLE_IDS = {
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // View IDs
    const VIEW_IDS = {
        'Agent 1': 'vw6qsy9bhjjmp2uj',
        'Agent 2': 'vwkbmwz2s27sfmaf',
        'Agent 3': 'vwinp2ry3tsgs05v',
        'Agent 4': 'vw1pfyodq1rue5qa',
        'Agent 5': 'vwm662zy0mgsa6sz',
        'Agent 6': 'vwg9aurks8a990r4',
        'Agent 7': 'vwd1mneqgdxgxsyp',
        'Agent 8': 'vwgnatfcc29lnwxe',
        'Agent 9': 'vw7svg5hmw7ynq5t',
        'Agent 10': 'vwy47pqclq52v8o0',
        'Agent 11': 'vwfv3a57j5pe6d66',
        'Agent 12': 'vw3n15cpn8oazt71'
    };
    
    // DOM Elements
    const clientFilterDate = document.getElementById('clientFilterDate');
    const clientFilterAll = document.getElementById('clientFilterAll');
    const clientFilterStage = document.getElementById('clientFilterStage');
    const clientFilterButton = document.getElementById('clientFilterButton');
    const clientLoading = document.getElementById('clientLoading');
    const clientResults = document.getElementById('clientResults');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsCount = document.getElementById('resultsCount');
    const clientCardContainer = document.getElementById('clientCardContainer');
    const noClientsFound = document.getElementById('noClientsFound');
    
    // Modal Elements
    const updateClientModal = document.getElementById('updateClientModal');
    const closeModal = document.getElementById('closeModal');
    const updateClientPhone = document.getElementById('updateClientPhone');
    const updateClientCurrentStage = document.getElementById('updateClientCurrentStage');
    const updateClientStage = document.getElementById('updateClientStage');
    const updateTrialDurationContainer = document.getElementById('updateTrialDurationContainer');
    const updateDurationHours = document.getElementById('updateDurationHours');
    const updateDurationMinutes = document.getElementById('updateDurationMinutes');
    const updateDurationSeconds = document.getElementById('updateDurationSeconds');
    const updateCallLaterDateContainer = document.getElementById('updateCallLaterDateContainer');
    const updateCallLaterDate = document.getElementById('updateCallLaterDate');
    const updateClientNotes = document.getElementById('updateClientNotes');
    const updateClientButton = document.getElementById('updateClientButton');
    
    // Set today as default date
    const today = new Date().toISOString().split('T')[0];
    clientFilterDate.value = today;
    
    // Initialize min date for date pickers
    clientFilterDate.min = "2023-01-01"; // Set a reasonable min date
    updateCallLaterDate.min = today;
    
    // Event Listeners
    
    // Toggle date input based on "All" checkbox
    clientFilterAll.addEventListener('change', function() {
        clientFilterDate.disabled = this.checked;
    });
    
    // View clients button click
    clientFilterButton.addEventListener('click', function() {
        const allDates = clientFilterAll.checked;
        const date = clientFilterDate.value;
        const stage = clientFilterStage.value;
        
        if (!allDates && !date) {
            alert('Please select a date or check "All Dates"');
            return;
        }
        
        if (!stage) {
            alert('Please select a lead stage');
            return;
        }
        
        // Fetch clients
        fetchClientsByStageAndDate(stage, allDates ? null : date);
    });
    
    // Close modal button
    closeModal.addEventListener('click', function() {
        updateClientModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === updateClientModal) {
            updateClientModal.style.display = 'none';
        }
    });
    
    // Toggle additional fields based on selected stage in update modal
    updateClientStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle trial duration container
        if (selectedStage === 'Trial Attended') {
            updateTrialDurationContainer.style.display = 'block';
        } else {
            updateTrialDurationContainer.style.display = 'none';
        }
        
        // Toggle call later date container
        if (selectedStage === 'Call Later') {
            updateCallLaterDateContainer.style.display = 'block';
        } else {
            updateCallLaterDateContainer.style.display = 'none';
        }
    });
    
    // Update client button click
    updateClientButton.addEventListener('click', function() {
        const phone = updateClientPhone.textContent;
        const newStage = updateClientStage.value;
        const notes = updateClientNotes.value;
        
        // Check if new stage is selected
        if (!newStage) {
            if (!notes || notes.trim() === '') {
                alert('Please select a new stage or add notes for update');
                return;
            }
        }
        
        // Additional validation for specific stages
        if (newStage === 'Call Later' && !updateCallLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Process the update
        updateClient(phone, newStage, notes);
    });
    
    // Fetch clients by stage and date
    async function fetchClientsByStageAndDate(stage, date) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        clientLoading.style.display = 'flex';
        clientResults.style.display = 'none';
        clientCardContainer.innerHTML = '';
        noClientsFound.style.display = 'none';
        
        try {
            // Construct the query URL
            let queryUrl = `https://nocodb.tsblive.in/api/v2/tables/${tableId}/records?sort=-Id`;
            
            // Add stage filter
            const leadStageParam = encodeURIComponent('Lead Stage');
            queryUrl += `&where=(${leadStageParam},eq,${encodeURIComponent(stage)})`;
            
            // Add date filter if provided
            if (date) {
                queryUrl += `~and(Date,eq,exactDate,${date})`;
            }
            
            const response = await fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch clients: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Display results
            displayClientResults(data.list, stage, date);
            
        } catch (error) {
            console.error('Error fetching clients:', error);
            clientLoading.style.display = 'none';
            alert(`Error fetching clients: ${error.message}`);
        }
    }
    
    // Display client results
    function displayClientResults(clients, stage, date) {
        // Hide loading
        clientLoading.style.display = 'none';
        
        // Update results title and count
        resultsTitle.textContent = `Clients with Stage: ${stage}`;
        if (date) {
            resultsTitle.textContent += ` on ${formatDate(date)}`;
        }
        
        if (!clients || clients.length === 0) {
            // Show no results
            noClientsFound.style.display = 'block';
            resultsCount.textContent = '0 clients found';
            clientResults.style.display = 'block';
            return;
        }
        
        // Update count
        resultsCount.textContent = `${clients.length} clients found`;
        
        // Clear container
        clientCardContainer.innerHTML = '';
        
        // Add each client as a card
        clients.forEach(client => {
            const card = document.createElement('div');
            card.className = 'client-card';
            
            // Convert stage class (lowercase, replace spaces with hyphens)
            const stageClass = `stage-${(client['Lead Stage'] || '').toLowerCase().replace(/\s+/g, '-')}`;
            
            card.innerHTML = `
                <div class="client-card-header">
                    <h3 class="client-card-title">${client.Phone || 'No Phone'}</h3>
                    <span class="client-card-stage ${stageClass}">${client['Lead Stage'] || 'Unknown'}</span>
                </div>
                <div class="client-card-content">
                    <p><span class="client-card-label">Date:</span> ${client.Date || 'N/A'}</p>
                    <p><span class="client-card-label">Time:</span> ${client.Time || 'N/A'}</p>
                    <p><span class="client-card-label">Source:</span> ${client.Source || 'N/A'}</p>
                    ${client.Duration ? `<p><span class="client-card-label">Duration:</span> ${client.Duration}</p>` : ''}
                    <p><span class="client-card-label">Notes:</span> ${client.Notes || 'No notes'}</p>
                </div>
                <div class="client-card-actions">
                    <a href="tel:${client.Phone}" class="btn btn-success btn-sm">
                        <i class="fas fa-phone"></i> Call
                    </a>
                    <a href="https://wa.me/91${client.Phone}" class="btn btn-success btn-sm">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                    <button class="btn btn-primary btn-sm update-client-btn" 
                            data-phone="${client.Phone}"
                            data-stage="${client['Lead Stage'] || ''}"
                            data-notes="${client.Notes || ''}"
                            data-id="${client.Id}"
                            data-duration="${client.Duration || ''}">
                        Update
                    </button>
                </div>
            `;
            
            clientCardContainer.appendChild(card);
        });
        
        // Add event listeners to update buttons
        const updateButtons = document.querySelectorAll('.update-client-btn');
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const phone = this.getAttribute('data-phone');
                const stage = this.getAttribute('data-stage');
                const notes = this.getAttribute('data-notes');
                const id = this.getAttribute('data-id');
                const duration = this.getAttribute('data-duration');
                
                openUpdateModal(phone, stage, notes, id, duration);
            });
        });
        
        // Show results
        clientResults.style.display = 'block';
    }
    
    // Open update modal
    function openUpdateModal(phone, stage, notes, id, duration) {
        // Set values in modal
        updateClientPhone.textContent = phone;
        updateClientCurrentStage.textContent = stage;
        updateClientNotes.value = notes;
        
        // Reset selections
        updateClientStage.value = '';
        updateDurationHours.value = '0';
        updateDurationMinutes.value = '0';
        updateDurationSeconds.value = '0';
        updateCallLaterDate.value = '';
        
        // Hide conditional containers
        updateTrialDurationContainer.style.display = 'none';
        updateCallLaterDateContainer.style.display = 'none';
        
        // Set data attribute for ID
        updateClientButton.setAttribute('data-id', id);
        
        // Parse duration if available
        if (duration) {
            const durationMatch = duration.match(/(\d+)hr(\d+)min(\d+)sec/);
            if (durationMatch) {
                updateDurationHours.value = durationMatch[1];
                updateDurationMinutes.value = durationMatch[2];
                updateDurationSeconds.value = durationMatch[3];
            }
        }
        
        // Show modal
        updateClientModal.style.display = 'block';
    }
    
    // Update client
    async function updateClient(phone, newStage, notes) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        const tableId = TABLE_IDS[agentCode];
        const clientId = updateClientButton.getAttribute('data-id');
        
        if (!tableId || !clientId) {
            alert('Missing table ID or client ID');
            return;
        }
        
        // Prepare update data
        const updateData = {
            Id: clientId
        };
        
        // Add notes if provided
        if (notes && notes.trim() !== '') {
            updateData.Notes = notes;
        }
        
        // Add new stage if provided
        if (newStage) {
            updateData['Lead Stage'] = newStage;
            
            // Add callback date if Call Later
            if (newStage === 'Call Later') {
                const callbackDate = updateCallLaterDate.value;
                if (!callbackDate) {
                    alert('Please select a call back date');
                    return;
                }
                updateData.Date = callbackDate;
            }
            
            // Add duration if Trial Attended
            if (newStage === 'Trial Attended') {
                const hours = parseInt(updateDurationHours.value) || 0;
                const minutes = parseInt(updateDurationMinutes.value) || 0;
                const seconds = parseInt(updateDurationSeconds.value) || 0;
                
                // Format duration
                const duration = `${hours}hr${minutes}min${seconds}sec`;
                updateData.Duration = duration;
            }
        }
        
        try {
            // Show loading in modal
            updateClientButton.disabled = true;
            updateClientButton.textContent = 'Updating...';
            
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify([updateData])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update client: ${response.statusText}`);
            }
            
            // Close modal and refresh results
            updateClientModal.style.display = 'none';
            
            // Refresh the client list
            const stage = clientFilterStage.value;
            const date = clientFilterAll.checked ? null : clientFilterDate.value;
            fetchClientsByStageAndDate(stage, date);
            
            // Show success message
            alert('Client updated successfully');
            
        } catch (error) {
            console.error('Error updating client:', error);
            alert(`Error updating client: ${error.message}`);
        } finally {
            updateClientButton.disabled = false;
            updateClientButton.textContent = 'Update Client';
        }
    }
    
    // Helper function to format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    // Initialize component
    function initMyClientDetails() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.my-client-details-container').style.display = 'none';
            return;
        }
    }
    
    // Add event listener for agent login
    document.addEventListener('agentLoggedIn', initMyClientDetails);
    
    // Initialize on DOM content loaded
    initMyClientDetails();
});
</script>
            
        </div>
        
        <div id="checkIndividualLeadSection" class="crm-section">
            <!-- Check Individual Lead Component will be inserted here -->
            
            <!-- Check Individual Lead Component -->
<div class="crm-container check-individual-lead-container">
    <div class="crm-card">
        <div class="crm-card-header">
            <h2>Check Individual Lead</h2>
        </div>
        <div class="crm-card-body">
            <p class="section-description">Search for a specific lead by phone number.</p>
            
            <div class="search-form">
                <div class="form-group">
                    <label for="searchLeadPhone">Enter Phone Number:</label>
                    <div class="search-input-container">
                        <input type="tel" id="searchLeadPhone" class="form-control" placeholder="Enter 10 digit phone number" pattern="[0-9]{10}" maxlength="10">
                        <button id="searchLeadButton" class="btn btn-primary">Search</button>
                    </div>
                    <small class="form-text">Enter 10 digit phone number without country code</small>
                </div>
            </div>
            
            <div id="leadSearchLoading" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Searching for lead...</p>
            </div>
            
            <div id="leadSearchResults" class="lead-search-results" style="display: none;">
                <div class="results-header">
                    <h3 id="leadSearchTitle">Lead Results</h3>
                    <span id="leadSearchCount" class="results-count">0 records found</span>
                </div>
                
                <div id="leadSearchCardContainer" class="lead-search-card-container">
                    <!-- Lead cards will be inserted here dynamically -->
                </div>
                
                <div id="noLeadFound" class="no-results" style="display: none;">
                    <p>No lead found with this phone number in your records.</p>
                </div>
            </div>
            
            <!-- Update Lead Modal (reusing the same structure as in My Client Details) -->
            <div id="updateLeadModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Update Lead</h3>
                        <span id="closeLeadModal" class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="client-info-display">
                            <p><strong>Phone:</strong> <span id="updateLeadPhone"></span></p>
                            <p><strong>Current Stage:</strong> <span id="updateLeadCurrentStage"></span></p>
                        </div>
                        
                        <div class="form-group">
                            <label for="updateLeadStage">New Lead Stage:</label>
                            <select id="updateLeadStage" class="form-control">
                                <option value="" disabled selected>Select new stage</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Transfer">Transfer</option>
                                <option value="App Pending">App Pending</option>
                                <option value="App Done">App Done</option>
                                <option value="Trial Enrolled">Trial Enrolled</option>
                                <option value="Trial Attended">Trial Attended</option>
                                <option value="Call Later">Call Later</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                        
                        <!-- Trial Attended duration picker (hidden by default) -->
                        <div id="updateLeadDurationContainer" class="form-group" style="display: none;">
                            <label>Update Trial Duration:</label>
                            <div class="duration-picker">
                                <div class="duration-field">
                                    <input type="number" id="updateLeadDurationHours" class="form-control" min="0" max="23" value="0">
                                    <label>Hours</label>
                                </div>
                                <div class="duration-field">
                                    <input type="number" id="updateLeadDurationMinutes" class="form-control" min="0" max="59" value="0">
                                    <label>Minutes</label>
                                </div>
                                <div class="duration-field">
                                    <input type="number" id="updateLeadDurationSeconds" class="form-control" min="0" max="59" value="0">
                                    <label>Seconds</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call Later date picker (hidden by default) -->
                        <div id="updateLeadCallLaterDateContainer" class="form-group" style="display: none;">
                            <label for="updateLeadCallLaterDate">Select New Call Back Date:</label>
                            <input type="date" id="updateLeadCallLaterDate" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="updateLeadNotes">Update Notes:</label>
                            <textarea id="updateLeadNotes" class="form-control" rows="3" placeholder="Add or update notes..."></textarea>
                        </div>
                        
                        <button id="updateLeadButton" class="btn btn-primary btn-block">Update Lead</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Extending the existing styles */
.check-individual-lead-container {
    max-width: 800px;
    margin-top: 2rem;
}

.search-input-container {
    display: flex;
    gap: 0.5rem;
}

.search-input-container .form-control {
    flex: 1;
}

.form-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: var(--gray-color);
}

.lead-search-results {
    margin-top: 2rem;
}

.lead-search-card-container {
    margin: 1rem 0;
    max-height: 500px;
    overflow-y: auto;
}

.lead-search-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
}

@media (max-width: 576px) {
    .search-input-container {
        flex-direction: column;
    }
    
    .search-input-container .btn {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs (from your provided API calls)
    const TABLE_IDS = {
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const searchLeadPhone = document.getElementById('searchLeadPhone');
    const searchLeadButton = document.getElementById('searchLeadButton');
    const leadSearchLoading = document.getElementById('leadSearchLoading');
    const leadSearchResults = document.getElementById('leadSearchResults');
    const leadSearchTitle = document.getElementById('leadSearchTitle');
    const leadSearchCount = document.getElementById('leadSearchCount');
    const leadSearchCardContainer = document.getElementById('leadSearchCardContainer');
    const noLeadFound = document.getElementById('noLeadFound');
    
    // Modal Elements
    const updateLeadModal = document.getElementById('updateLeadModal');
    const closeLeadModal = document.getElementById('closeLeadModal');
    const updateLeadPhone = document.getElementById('updateLeadPhone');
    const updateLeadCurrentStage = document.getElementById('updateLeadCurrentStage');
    const updateLeadStage = document.getElementById('updateLeadStage');
    const updateLeadDurationContainer = document.getElementById('updateLeadDurationContainer');
    const updateLeadDurationHours = document.getElementById('updateLeadDurationHours');
    const updateLeadDurationMinutes = document.getElementById('updateLeadDurationMinutes');
    const updateLeadDurationSeconds = document.getElementById('updateLeadDurationSeconds');
    const updateLeadCallLaterDateContainer = document.getElementById('updateLeadCallLaterDateContainer');
    const updateLeadCallLaterDate = document.getElementById('updateLeadCallLaterDate');
    const updateLeadNotes = document.getElementById('updateLeadNotes');
    const updateLeadButton = document.getElementById('updateLeadButton');
    
    // Set today as min date for call later
    const today = new Date().toISOString().split('T')[0];
    updateLeadCallLaterDate.min = today;
    
    // Event Listeners
    
    // Search lead button click
    searchLeadButton.addEventListener('click', function() {
        const phone = searchLeadPhone.value;
        
        if (!phone || phone.length !== 10 || !/^\d+$/.test(phone)) {
            alert('Please enter a valid 10 digit phone number');
            return;
        }
        
        // Search for lead
        searchLeadByPhone(phone);
    });
    
    // Enter key in phone input
    searchLeadPhone.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchLeadButton.click();
        }
    });
    
    // Close modal button
    closeLeadModal.addEventListener('click', function() {
        updateLeadModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === updateLeadModal) {
            updateLeadModal.style.display = 'none';
        }
    });
    
    // Toggle additional fields based on selected stage in update modal
    updateLeadStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle trial duration container
        if (selectedStage === 'Trial Attended') {
            updateLeadDurationContainer.style.display = 'block';
        } else {
            updateLeadDurationContainer.style.display = 'none';
        }
        
        // Toggle call later date container
        if (selectedStage === 'Call Later') {
            updateLeadCallLaterDateContainer.style.display = 'block';
        } else {
            updateLeadCallLaterDateContainer.style.display = 'none';
        }
    });
    
    // Update lead button click
    updateLeadButton.addEventListener('click', function() {
        const phone = updateLeadPhone.textContent;
        const newStage = updateLeadStage.value;
        const notes = updateLeadNotes.value;
        
        // Check if new stage is selected
        if (!newStage) {
            if (!notes || notes.trim() === '') {
                alert('Please select a new stage or add notes for update');
                return;
            }
        }
        
        // Additional validation for specific stages
        if (newStage === 'Call Later' && !updateLeadCallLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Process the update
        updateLead(phone, newStage, notes);
    });
    
    // Search for lead by phone number
    async function searchLeadByPhone(phone) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        leadSearchLoading.style.display = 'flex';
        leadSearchResults.style.display = 'none';
        leadSearchCardContainer.innerHTML = '';
        noLeadFound.style.display = 'none';
        
        try {
            // Construct the query URL
            const queryUrl = `https://nocodb.tsblive.in/api/v2/tables/${tableId}/records?where=(Phone,eq,${phone})&sort=-Id`;
            
            const response = await fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to search lead: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Display results
            displayLeadSearchResults(data.list, phone);
            
        } catch (error) {
            console.error('Error searching lead:', error);
            leadSearchLoading.style.display = 'none';
            alert(`Error searching lead: ${error.message}`);
        }
    }
    
    // Display lead search results
    function displayLeadSearchResults(leads, phone) {
        // Hide loading
        leadSearchLoading.style.display = 'none';
        
        // Update results title and count
        leadSearchTitle.textContent = `Results for: ${phone}`;
        
        if (!leads || leads.length === 0) {
            // Show no results
            noLeadFound.style.display = 'block';
            leadSearchCount.textContent = '0 records found';
            leadSearchResults.style.display = 'block';
            return;
        }
        
        // Update count
        leadSearchCount.textContent = `${leads.length} records found`;
        
        // Clear container
        leadSearchCardContainer.innerHTML = '';
        
        // Add each lead as a card
        leads.forEach(lead => {
            const card = document.createElement('div');
            card.className = 'lead-search-card';
            
            // Convert stage class (lowercase, replace spaces with hyphens)
            const stageClass = `stage-${(lead['Lead Stage'] || '').toLowerCase().replace(/\s+/g, '-')}`;
            
            card.innerHTML = `
                <div class="client-card-header">
                    <h3 class="client-card-title">${lead.Phone || 'No Phone'}</h3>
                    <span class="client-card-stage ${stageClass}">${lead['Lead Stage'] || 'Unknown'}</span>
                </div>
                <div class="client-card-content">
                    <p><span class="client-card-label">Date:</span> ${lead.Date || 'N/A'}</p>
                    <p><span class="client-card-label">Time:</span> ${lead.Time || 'N/A'}</p>
                    <p><span class="client-card-label">Source:</span> ${lead.Source || 'N/A'}</p>
                    ${lead.Duration ? `<p><span class="client-card-label">Duration:</span> ${lead.Duration}</p>` : ''}
                    <p><span class="client-card-label">Notes:</span> ${lead.Notes || 'No notes'}</p>
                </div>
                <div class="client-card-actions">
                    <a href="tel:${lead.Phone}" class="btn btn-success btn-sm">
                        <i class="fas fa-phone"></i> Call
                    </a>
                    <a href="https://wa.me/91${lead.Phone}" class="btn btn-success btn-sm">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                    <button class="btn btn-primary btn-sm update-lead-btn" 
                            data-phone="${lead.Phone}"
                            data-stage="${lead['Lead Stage'] || ''}"
                            data-notes="${lead.Notes || ''}"
                            data-id="${lead.Id}"
                            data-duration="${lead.Duration || ''}">
                        Update
                    </button>
                </div>
            `;
            
            leadSearchCardContainer.appendChild(card);
        });
        
        // Add event listeners to update buttons
        const updateButtons = document.querySelectorAll('.update-lead-btn');
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const phone = this.getAttribute('data-phone');
                const stage = this.getAttribute('data-stage');
                const notes = this.getAttribute('data-notes');
                const id = this.getAttribute('data-id');
                const duration = this.getAttribute('data-duration');
                
                openUpdateLeadModal(phone, stage, notes, id, duration);
            });
        });
        
        // Show results
        leadSearchResults.style.display = 'block';
    }
    
    // Open update lead modal
    function openUpdateLeadModal(phone, stage, notes, id, duration) {
        // Set values in modal
        updateLeadPhone.textContent = phone;
        updateLeadCurrentStage.textContent = stage;
        updateLeadNotes.value = notes;
        
        // Reset selections
        updateLeadStage.value = '';
        updateLeadDurationHours.value = '0';
        updateLeadDurationMinutes.value = '0';
        updateLeadDurationSeconds.value = '0';
        updateLeadCallLaterDate.value = '';
        
        // Hide conditional containers
        updateLeadDurationContainer.style.display = 'none';
        updateLeadCallLaterDateContainer.style.display = 'none';
        
        // Set data attribute for ID
        updateLeadButton.setAttribute('data-id', id);
        
        // Parse duration if available
        if (duration) {
            const durationMatch = duration.match(/(\d+)hr(\d+)min(\d+)sec/);
            if (durationMatch) {
                updateLeadDurationHours.value = durationMatch[1];
                updateLeadDurationMinutes.value = durationMatch[2];
                updateLeadDurationSeconds.value = durationMatch[3];
            }
        }
        
        // Show modal
        updateLeadModal.style.display = 'block';
    }
    
    // Update lead
    async function updateLead(phone, newStage, notes) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        const tableId = TABLE_IDS[agentCode];
        const leadId = updateLeadButton.getAttribute('data-id');
        
        if (!tableId || !leadId) {
            alert('Missing table ID or lead ID');
            return;
        }
        
        // Prepare update data
        const updateData = {
            Id: leadId
        };
        
        // Add notes if provided
        if (notes && notes.trim() !== '') {
            updateData.Notes = notes;
        }
        
        // Add new stage if provided
        if (newStage) {
            updateData['Lead Stage'] = newStage;
            
            // Add callback date if Call Later
            if (newStage === 'Call Later') {
                const callbackDate = updateLeadCallLaterDate.value;
                if (!callbackDate) {
                    alert('Please select a call back date');
                    return;
                }
                updateData.Date = callbackDate;
            }
            
            // Add duration if Trial Attended
            if (newStage === 'Trial Attended') {
                const hours = parseInt(updateLeadDurationHours.value) || 0;
                const minutes = parseInt(updateLeadDurationMinutes.value) || 0;
                const seconds = parseInt(updateLeadDurationSeconds.value) || 0;
                
                // Format duration
                const duration = `${hours}hr${minutes}min${seconds}sec`;
                updateData.Duration = duration;
            }
        }
        
        try {
            // Show loading in modal
            updateLeadButton.disabled = true;
            updateLeadButton.textContent = 'Updating...';
            
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify([updateData])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update lead: ${response.statusText}`);
            }
            
            // Close modal
            updateLeadModal.style.display = 'none';
            
            // Refresh the search results
            searchLeadByPhone(phone);
            
            // Show success message
            alert('Lead updated successfully');
            
        } catch (error) {
            console.error('Error updating lead:', error);
            alert(`Error updating lead: ${error.message}`);
        } finally {
            updateLeadButton.disabled = false;
            updateLeadButton.textContent = 'Update Lead';
        }
    }
    
    // Initialize component
    function initCheckIndividualLead() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.check-individual-lead-container').style.display = 'none';
            return;
        }
    }
    
    // Add event listener for agent login
    document.addEventListener('agentLoggedIn', initCheckIndividualLead);
    
    // Initialize on DOM content loaded
    initCheckIndividualLead();
});
</script>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const sectionTabs = document.getElementById('sectionTabs');
            const tabButtons = document.querySelectorAll('.section-tab');
            const sections = document.querySelectorAll('.crm-section');
            const agentDisplay = document.querySelector('.agent-display');
            const navLogoutBtn = document.getElementById('navLogoutBtn');
            
            // Check if agent is logged in
            function checkAgentLogin() {
                const agentCode = localStorage.getItem('agentCode');
                const agentName = localStorage.getItem('agentName');
                
                if (agentCode && agentName) {
                    // Display agent info in navbar
                    document.querySelectorAll('.agent-code-display').forEach(el => {
                        el.textContent = agentCode;
                    });
                    
                    document.querySelectorAll('.agent-name-display').forEach(el => {
                        el.textContent = agentName;
                    });
                    
                    // Show agent display and tabs
                    agentDisplay.style.display = 'block';
                    sectionTabs.style.display = 'flex';
                    
                    // Hide agent selection, show lead management
                    document.getElementById('agentSelectionSection').classList.remove('active');
                    document.getElementById('leadManagementSection').classList.add('active');
                    
                    // Update active tab
                    tabButtons.forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.getAttribute('data-section') === 'lead-management') {
                            tab.classList.add('active');
                        }
                    });
                } else {
                    // Hide agent display and tabs
                    agentDisplay.style.display = 'none';
                    sectionTabs.style.display = 'none';
                    
                    // Show agent selection
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById('agentSelectionSection').classList.add('active');
                }
            }
            
            // Tab click handler
            tabButtons.forEach(tab => {
                tab.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    
                    // Update active tab
                    tabButtons.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Show selected section
                    const selectedSection = document.getElementById(`${sectionId}Section`);
                    if (selectedSection) {
                        selectedSection.classList.add('active');
                    }
                });
            });
            
            // Logout button click
            navLogoutBtn.addEventListener('click', function() {
                if (window.logoutAgent) {
                    window.logoutAgent();
                } else {
                    localStorage.removeItem('agentCode');
                    localStorage.removeItem('agentName');
                    localStorage.removeItem('agentNumber');
                    window.location.reload();
                }
            });
            
            // Listen for agent login event
            document.addEventListener('agentLoggedIn', function() {
                checkAgentLogin();
            });
            
            // Check on page load
            checkAgentLogin();
            
            // Communication between components
            
            // Get new lead requested from Not My Lead
            document.addEventListener('getNewLeadRequested', function() {
                // Switch to Lead Management
                tabButtons.forEach(tab => {
                    if (tab.getAttribute('data-section') === 'lead-management') {
                        tab.click();
                    }
                });
                
                // Click the Get Lead button
                const getLeadButton = document.getElementById('getLeadButton');
                if (getLeadButton) {
                    getLeadButton.click();
                }
            });
        });
    </script>
</body>
</html>