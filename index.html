<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Assignment CRM</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        /* Global styles */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f72585;
            --call-button: #3db63d;      /* Green for call button */
            --whatsapp-button: #25D366;  /* WhatsApp brand color */
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: #212529;
            line-height: 1.5;
            padding-bottom: 2rem;
        }
        
        .navbar {
            background-color: #4361ee;
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .navbar-title {
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        .navbar-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .agent-display {
            display: none;  /* Will be shown when logged in */
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .crm-section {
            margin-bottom: 2rem;
        }
        
        .section-divider {
            height: 1px;
            background-color: var(--light-gray);
            margin: 2rem 0;
        }
        
        /* Common utility classes */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            background-color: white;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.25);
        }
        
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
        }

        .btn-primary {
            color: white;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success {
            color: white;
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3db8dc;
            border-color: #3db8dc;
        }
        
        .btn-call {
            color: white;
            background-color: var(--call-button);
            border-color: var(--call-button);
        }
        
        .btn-call:hover {
            background-color: #339633;
            border-color: #339633;
        }
        
        .btn-whatsapp {
            color: white;
            background-color: var(--whatsapp-button);
            border-color: var(--whatsapp-button);
        }
        
        .btn-whatsapp:hover {
            background-color: #20b858;
            border-color: #20b858;
        }

        .btn-block {
            display: block;
            width: 100%;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .section-title {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--dark-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .navbar-title {
                font-size: 1rem;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .card-header h2 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-title">Lead Assignment CRM</div>
            <div class="navbar-info">
                <div class="agent-display">
                    <span class="agent-code-display"></span> | <span class="agent-name-display"></span>
                </div>
                <button id="navLogoutBtn" class="logout-btn" style="display: none;">Logout</button>
            </div>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Agent Selection Section -->
        <div id="agentSelectionSection" class="crm-section">
            <!-- Agent Selection Component will be inserted here -->

<!-- Agent Selection Component -->
<div class="card agent-selection-container">
    <div class="card-header">
        <h2>Agent Login</h2>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label for="agentCode">Select Agent Code:</label>
            <select id="agentCode" class="form-control">
                <option value="" disabled selected>Select your agent code</option>
                <option value="Agent 1">Agent 1</option>
                <option value="Agent 2">Agent 2</option>
                <option value="Agent 3">Agent 3</option>
                <option value="Agent 4">Agent 4</option>
                <option value="Agent 5">Agent 5</option>
                <option value="Agent 6">Agent 6</option>
                <option value="Agent 7">Agent 7</option>
                <option value="Agent 8">Agent 8</option>
                <option value="Agent 9">Agent 9</option>
                <option value="Agent 10">Agent 10</option>
                <option value="Agent 11">Agent 11</option>
                <option value="Agent 12">Agent 12</option>
            </select>
        </div>
        <div class="form-group">
            <label for="agentName">Enter Your Name:</label>
            <input type="text" id="agentName" class="form-control" placeholder="Enter your name">
        </div>
        <button id="loginButton" class="btn btn-primary btn-block">Continue to Lead Management</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if agent info exists in localStorage (but preserve lead data)
    const storedAgentCode = localStorage.getItem('agentCode');
    const storedAgentName = localStorage.getItem('agentName');
    
    // If agent info exists, pre-fill the form
    if (storedAgentCode && storedAgentName) {
        document.getElementById('agentCode').value = storedAgentCode;
        document.getElementById('agentName').value = storedAgentName;
    }
    
    // Handle login button click
    document.getElementById('loginButton').addEventListener('click', function() {
        const agentCode = document.getElementById('agentCode').value;
        const agentName = document.getElementById('agentName').value;
        
        // Validate inputs
        if (!agentCode) {
            alert('Please select your Agent Code');
            return;
        }
        
        if (!agentName || agentName.trim() === '') {
            alert('Please enter your name');
            return;
        }
        
        // Save to localStorage
        localStorage.setItem('agentCode', agentCode);
        localStorage.setItem('agentName', agentName);
        
        // Get agent number from agent code for API calls
        const agentNumber = agentCode.replace('Agent ', '');
        localStorage.setItem('agentNumber', agentNumber);
        
        // Dispatch the agentLoggedIn event
        document.dispatchEvent(new CustomEvent('agentLoggedIn', {
            detail: { agentCode, agentName, agentNumber }
        }));
    });
});
</script>
            
        </div>
        
        <!-- Dashboard Section - Only visible after login -->
        <div id="dashboardSection" class="crm-section" style="display: none;">
            <!-- Dashboard Component will be inserted here -->
            <!-- Dashboard Card Section -->
<div class="card dashboard-container">
    <div class="card-header">
        <h2>Dashboard</h2>
    </div>
    <div class="card-body">
        <div class="dashboard-controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="dashboardDate">Select Date:</label>
                    <input type="date" id="dashboardDate" class="form-control">
                </div>
                <div class="refresh-button-container">
                    <button id="refreshDashboard" class="btn btn-primary">
                        <span class="refresh-icon">↻</span> Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <div id="dashboardLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Loading dashboard data...</p>
        </div>
        
        <div id="dashboardStats" class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon stat-follow-up">
                    <span>↻</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">Follow Up</h3>
                    <p class="stat-value" id="followUpCount">0</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon stat-app-pending">
                    <span>⌛</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">App Pending</h3>
                    <p class="stat-value" id="appPendingCount">0</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon stat-app-done">
                    <span>✓</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">App Done</h3>
                    <p class="stat-value" id="appDoneCount">0</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon stat-trial-enrolled">
                    <span>★</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">Trial Enrolled</h3>
                    <p class="stat-value" id="trialEnrolledCount">0</p>
                </div>
            </div>
            
            <!-- New Card for Transfer -->
            <div class="stat-card">
                <div class="stat-icon stat-transfer">
                    <span>⇄</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">Transfer</h3>
                    <p class="stat-value" id="transferCount">0</p>
                </div>
            </div>
            
            <!-- New Card for WhatsApp -->
            <div class="stat-card">
                <div class="stat-icon stat-whatsapp">
                    <span>✉</span>
                </div>
                <div class="stat-content">
                    <h3 class="stat-title">WhatsApp</h3>
                    <p class="stat-value" id="whatsappCount">0</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dashboard specific styles */
.dashboard-controls {
    margin-bottom: 1.5rem;
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -0.5rem;
    margin-left: -0.5rem;
    align-items: flex-end;
}

.form-row > .form-group {
    flex: 1;
    padding: 0 0.5rem;
}

.refresh-button-container {
    padding: 0 0.5rem;
    display: flex;
    align-items: flex-end;
}

.refresh-icon {
    display: inline-block;
    margin-right: 0.25rem;
}

.dashboard-stats {
    display: flex;
    flex-wrap: wrap;
    margin: -0.5rem;
}

.stat-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 1rem;
    margin: 0.5rem;
    flex: 1 1 calc(25% - 1rem);
    min-width: 170px;
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
    font-size: 1.25rem;
}

.stat-follow-up {
    background-color: var(--gray-color);
}

.stat-app-pending {
    background-color: var(--warning-color);
}

.stat-app-done {
    background-color: var(--accent-color);
}

.stat-trial-enrolled {
    background-color: var(--primary-color);
}

/* New stat icons styles */
.stat-transfer {
    background-color: #17a2b8; /* Teal/turquoise color */
}

.stat-whatsapp {
    background-color: #25D366; /* WhatsApp brand color */
}

.stat-content {
    flex: 1;
}

.stat-title {
    margin: 0;
    font-size: 0.9rem;
    color: var(--gray-color);
    font-weight: 500;
}

.stat-value {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--dark-color);
}

@media (max-width: 768px) {
    .stat-card {
        flex: 1 1 calc(50% - 1rem);
    }
}

@media (max-width: 480px) {
    .stat-card {
        flex: 1 1 100%;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .refresh-button-container {
        margin-top: 1rem;
        width: 100%;
    }
    
    .refresh-button-container .btn {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs for Agents
    const TABLE_IDS = {
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const dashboardDate = document.getElementById('dashboardDate');
    const refreshDashboard = document.getElementById('refreshDashboard');
    const dashboardLoading = document.getElementById('dashboardLoading');
    const dashboardStats = document.getElementById('dashboardStats');
    const followUpCount = document.getElementById('followUpCount');
    const appPendingCount = document.getElementById('appPendingCount');
    const appDoneCount = document.getElementById('appDoneCount');
    const trialEnrolledCount = document.getElementById('trialEnrolledCount');
    const transferCount = document.getElementById('transferCount'); // New element
    const whatsappCount = document.getElementById('whatsappCount'); // New element
    
    // Set today as default date
    const today = new Date().toISOString().split('T')[0];
    dashboardDate.value = today;
    
    // Initialize saved date from localStorage if available
    const savedDashboardDate = localStorage.getItem('dashboardDate');
    if (savedDashboardDate) {
        dashboardDate.value = savedDashboardDate;
    }
    
    // Refresh button click
    refreshDashboard.addEventListener('click', function() {
        const selectedDate = dashboardDate.value;
        
        if (!selectedDate) {
            alert('Please select a date');
            return;
        }
        
        // Save selected date to localStorage
        localStorage.setItem('dashboardDate', selectedDate);
        
        // Fetch dashboard data
        fetchDashboardData(selectedDate);
    });
    
    // Date change
    dashboardDate.addEventListener('change', function() {
        refreshDashboard.click();
    });
    
    // Fetch dashboard data
    async function fetchDashboardData(date) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        dashboardLoading.style.display = 'flex';
        dashboardStats.style.opacity = '0.5';
        
        try {
            // Query agent's table for the selected date
            const queryUrl = `https://nocodb.tsblive.in/api/v2/tables/${tableId}/records?where=(Date,eq,exactDate,${date})`;
            
            const response = await fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch dashboard data: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Process data and update stats
            updateDashboardStats(data.list);
            
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            alert(`Error fetching dashboard data: ${error.message}`);
        } finally {
            // Hide loading
            dashboardLoading.style.display = 'none';
            dashboardStats.style.opacity = '1';
        }
    }
    
    // Update dashboard stats
    function updateDashboardStats(leads) {
        // Initialize counters
        let followUp = 0;
        let appPending = 0;
        let appDone = 0;
        let trialEnrolled = 0;
        let transfer = 0; // New counter for Transfer
        let whatsapp = 0; // New counter for WhatsApp
        
        // Count leads by stage
        if (leads && leads.length > 0) {
            leads.forEach(lead => {
                const stage = lead['Lead Stage'];
                
                if (stage === 'Call Later') {
                    followUp++;
                } else if (stage === 'App Pending') {
                    appPending++;
                } else if (stage === 'App Done') {
                    appDone++;
                } else if (stage === 'Trial Enrolled') {
                    trialEnrolled++;
                } else if (stage === 'Transfer') { // New condition for Transfer
                    transfer++;
                } else if (stage === 'WhatsApp') { // New condition for WhatsApp
                    whatsapp++;
                }
            });
        }
        
        // Update stat values with animation
        animateCount(followUpCount, followUp);
        animateCount(appPendingCount, appPending);
        animateCount(appDoneCount, appDone);
        animateCount(trialEnrolledCount, trialEnrolled);
        animateCount(transferCount, transfer); // Update transfer count
        animateCount(whatsappCount, whatsapp); // Update WhatsApp count
    }
    
    // Animate count change
    function animateCount(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        const difference = newValue - currentValue;
        
        if (difference === 0) return;
        
        const duration = 500; // ms
        const steps = 20;
        const stepValue = difference / steps;
        let currentStep = 0;
        
        const timer = setInterval(() => {
            currentStep++;
            
            if (currentStep >= steps) {
                clearInterval(timer);
                element.textContent = newValue;
            } else {
                element.textContent = Math.round(currentValue + stepValue * currentStep);
            }
        }, duration / steps);
    }
    
    // Initialize component
    function initDashboard() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.dashboard-container').style.display = 'none';
            return;
        }
        
        // Load dashboard data
        refreshDashboard.click();
    }
    
    // Add event listener for agent login
    document.addEventListener('agentLoggedIn', function() {
        // Set timeout to allow agent info to be saved to localStorage
        setTimeout(initDashboard, 100);
    });
    
    // Initialize on DOM content loaded
    initDashboard();
});
</script>


        
        <!-- Lead Management Section - Only visible after login -->
        <div id="leadManagementSection" class="crm-section" style="display: none;">
            <!-- Lead Management Component will be inserted here -->

            <!-- Lead Management Component - PART 1 -->
<div class="card lead-management-container">
    <div class="card-header">
        <h2>Lead Management</h2>
    </div>
    <div class="card-body">
        <button id="getLeadButton" class="btn btn-primary btn-block">Get New Lead</button>
        
        <div id="leadDetailsContainer" class="lead-details-container" style="display: none;">
            <div class="lead-loading" id="leadLoading">
                <div class="spinner"></div>
                <p>Loading lead information...</p>
            </div>
            
            <div id="leadCardContainer" class="lead-card-container">
                <!-- Lead cards will be dynamically inserted here -->
            </div>
            
            <div class="lead-action-container">
                <div class="lead-action-buttons">
                    <a id="callButton" href="#" class="btn btn-call btn-block">Call</a>
                    <div class="whatsapp-container">
    <a id="whatsappButton" href="#" class="btn btn-whatsapp">WhatsApp</a>
    <button id="leadWhatsappTemplateBtn" class="btn btn-whatsapp-template dropdown-toggle">
        <span class="template-icon">➤</span>
    </button>
    <div id="leadWhatsappTemplateDropdown" class="lead-whatsapp-template-dropdown">
        <!-- Template options will be dynamically inserted here -->
    </div>
</div>
                </div>
                
                <div class="form-group">
                    <label for="leadNotes">Notes:</label>
                    <textarea id="leadNotes" class="form-control" rows="3" placeholder="Add notes about this lead..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="leadStage">Disposition Stage:</label>
                    <select id="leadStage" class="form-control">
                        <option value="" disabled selected>Select disposition</option>
                        <option value="No Response">No Response</option>
                        <option value="Not Interested">Not Interested</option>
                        <option value="App Pending">App Pending</option>
                        <option value="App Done">App Done</option>
                        <option value="Call Later">Call Later</option>
                        <option value="Trial Enrolled">Trial Enrolled</option>
                        <option value="Trial Attended">Trial Attended</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <!-- Call Later date picker (hidden by default) -->
                <div id="callLaterDateContainer" class="form-group" style="display: none;">
                    <label for="callLaterDate">Select Call Back Date:</label>
                    <input type="date" id="callLaterDate" class="form-control">
                </div>
                
                <!-- Trial Attended duration picker (hidden by default) -->
                <div id="trialDurationContainer" class="form-group" style="display: none;">
                    <label>Select Trial Duration:</label>
                    <div class="duration-picker">
                        <div class="duration-field">
                            <input type="number" id="durationHours" class="form-control" min="0" max="23" value="0">
                            <label>Hours</label>
                        </div>
                        <div class="duration-field">
                            <input type="number" id="durationMinutes" class="form-control" min="0" max="59" value="0">
                            <label>Minutes</label>
                        </div>
                        <div class="duration-field">
                            <input type="number" id="durationSeconds" class="form-control" min="0" max="59" value="0">
                            <label>Seconds</label>
                        </div>
                    </div>
                </div>
                
                <button id="submitLeadButton" class="btn btn-primary btn-block">Submit</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Lead Management specific styles */
.lead-details-container {
    margin-top: 1.5rem;
}

.lead-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.lead-card-container {
    margin: 1.5rem 0;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.lead-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
}

.lead-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.lead-card-title {
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
    font-size: 1.1rem;
}

.lead-card-content {
    margin-bottom: 0.5rem;
}

.lead-card-content p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
}

.lead-card-label {
    font-weight: 500;
    color: var(--gray-color);
}

.lead-action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.lead-action-buttons .btn-call {
    flex: 1;
    font-weight: bold;
    padding: 0.75rem 0;
    font-size: 1.1rem;
}

/* WhatsApp template dropdown styles */
.whatsapp-container {
    display: flex;
    flex: 1;
    position: relative;
}

.btn-whatsapp {
    flex: 1;
    font-weight: bold;
    padding: 0.75rem 0;
    font-size: 1.1rem;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-whatsapp-template {
    width: 40px;
    padding: 0.75rem 0;
    background-color: #1da851;
    color: white;
    border-color: #1da851;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    cursor: pointer;
}

.btn-whatsapp-template:hover {
    background-color: #19914b;
}

.template-icon {
    display: inline-block;
    font-size: 10px;
}

.lead-whatsapp-template-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    left: 0;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: none;
    max-height: 200px;
    overflow-y: auto;
}

.whatsapp-template-dropdown2 {
    position: absolute;
    top: 100%;
    right: 0;
    left: 0;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: none;
    max-height: 200px;
    overflow-y: auto;
}


.template-option {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.template-option:last-child {
    border-bottom: none;
}

.template-option:hover {
    background-color: #f5f5f5;
}

.template-option-title {
    font-weight: 500;
    font-size: 0.95rem;
    display: block;
    margin-bottom: 0.25rem;
}

.template-option-preview {
    font-size: 0.8rem;
    color: var(--gray-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.duration-picker {
    display: flex;
    gap: 0.5rem;
}

.duration-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.duration-field label {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

#submitLeadButton {
    margin-top: 1.5rem;
}

.lead-history-header {
    margin: 1rem 0 0.5rem 0;
    font-size: 1rem;
    color: var(--dark-color);
    font-weight: 500;
    border-bottom: 1px solid var(--light-gray);
    padding-bottom: 0.5rem;
}

@media (max-width: 576px) {
    .lead-action-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .duration-picker {
        flex-direction: column;
        gap: 0.75rem;
    }
}
</style>

<script>
// Lead Management Component - PART 2
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Webhook URLs
    const WEBHOOKS = {
        'no_response': 'https://flow.tsblive.in/webhook/e463bcac-0a06-4611-95f2-c001fc9585fb',
        'not_interested': 'https://flow.tsblive.in/webhook/1a89cda4-a800-4a29-8689-27b2ed6963d8',
        'trial_enrolled': 'https://flow.tsblive.in/webhook/71e8e763-d776-4794-ab1d-e942e8aba4a6'
    };
    
    // WhatsApp Templates
    // Format: { id: unique identifier, title: display name, message: the template message }
    const WHATSAPP_TEMPLATES = [
        { 
            id: 'sainik_intro', 
            title: 'Sainik Gift', 
            message: '*The Speedy Brains Academy* 🙏🏻\n\nAbhi aapse *Sainik School Coaching* ke liye baat hui hai.\n\n📚📚 *Study Material* for your child 👇🏻\n1️⃣ Sainik School *Syllabus*\n2️⃣ Previous *5 year* Question Bank\n3️⃣ Free Software to check *cutoff Marks* for Sainik School'
        },
        { 
            id: 'jnv_intro', 
            title: 'JNV Gift', 
            message: '*The Speedy Brains Academy* 🙏🏻\n\nAbhi aapse *Navodaya Coaching* ke liye baat hui hai.\n\n📚📚 *Study Material* for your child 👇🏻\n\n1️⃣ Navodaya *Syllabus*'
        },
        { 
            id: 'cutoff_sainik', 
            title: 'Sainik Cutoff', 
            message: '*Free Software for Sainik School*\n\n*For Class 6 and 9*\n\n📈 Cutoff Marks\n🎟️ Available Seats\n💰 Fees Detail\n\n*Click Here:* https://course.thespeedybrains.com/s/pages/sainik-school-cutoff-marks\n\nType *yes* if you are not able to click on link'
        },
        { 
            id: 'cutoff_jnv', 
            title: 'JNV Cutoff', 
            message: 'Cutoff Checker for JNV will be ready in a week.\n\nType *yes* if you are interested'
        },
        { 
            id: 'tt_jnv', 
            title: 'TimeTable JNV', 
            message: '*नवोदय विद्यालय की कोचिंग क्लास सोमवार से शनिवार प्रतिदिन होती है।*\n\n🔭 *Reasoning:* 4:00 to 4:50 pm\n📐 *Maths:* 5:00 to 5:50 pm\n👨‍🎓 *Eng/Hindi:* 7:00 to 7:50 pm\n\n💡 *प्रतिदिन प्रैक्टिस टेस्ट:* 8:00 to 9:00 pm\n\n📚 प्रतिदिन सुबह *5 बजे से 6 बजे तक Spoken English* की क्लास होती है\n\n👉 सभी क्लास में *उपस्थित रहना अनिवार्य* है । अनुपस्थित रहने पर माता पिता को कॉल एवं मैसेज करके बताया जाएगा प्रतिदिन'
        },
        { 
            id: 'tt_sainik_6', 
            title: 'TimeTable Sainik 6,4', 
            message: '*Online Coaching for Sainik School are held daily from Monday to Saturday*\n\n🔭 *Science:* 5:00 to 5:50 PM\n📐 *Maths:* 6:00 to 7:30 PM\n👨‍🎓 *English:* 8:00 to 8:50 PM\n💡 *Daily Practice Test:* 9:00 to 10:30 PM\n\n🔭 *Reasoning:* 4:00 to 4:50 PM (Fri & Sat)\n\n📚 *Spoken English Class:* 5:00 to 6:00 AM daily\n\n👉 Attendance in all *classes is mandatory.* If absent, parents will be informed *via call and message* every day.'
        },
        { 
            id: 'tt_sainik_9', 
            title: 'TimeTable Sainik 9', 
            message: '*Online Coaching for Sainik Class 9 are held daily from Monday to Saturday*\n\n🔭 *English:* 5:00 to 5:50 PM\n⚛️ *Science:* 6:00 to 6:50 PM\n👨‍🎓 *Sst:* 7:00 to 7:50 PM\n📐 *Maths:* 8:15 to 9:30 PM\n💡 *Daily Practice Test:* 9:00 to 10:30 PM\n\n🔭 *Reasoning:* Every Sunday\n\n📚 *Spoken English Class:* 5:00 to 6:00 AM daily\n\n👉 Attendance in all *classes is mandatory.* If absent, parents will be informed *via call and message* every day.'
        },
        { 
            id: 'app_downlaod', 
            title: 'App Download', 
            message: '*The Speedy Brains Academy*\n\nBest App for *Sainik and Navodaya* Coaching\n\n*Click Here:* https://play.google.com/store/apps/details?id=com.thespeedybrains.learners'
        },
        { 
            id: 'fees_structure', 
            title: 'Fees', 
            message: '🎯 *Online Coaching Fees Details*\n\n✅ 2 days *FREE Trial* (LIVE Class)\n👉 If you like it, get *1-week full access* for just *₹29* 💸\n\nIncludes:\n📖 Daily *LIVE* Classes\n📝 Daily *Tests* & Notes\n🎥 Recordings\n🗣️ *Spoken* English Class\n\nAfter 1 week, you can Join and *continue* if you’re happy 😊'
        }
    ];
    
    // NocoDB Table IDs
    const TABLE_IDS = {
        'main': 'mxrl7syu0qe3xu3',
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // NocoDB Table IDs for No Response and Not Interested
    const NO_RESPONSE_TABLE_ID = 'mwijnju0ilfa3t1';
    const NOT_INTERESTED_TABLE_ID = 'mo8mtemqthpdnsl';
    
    // DOM Elements
    const getLeadButton = document.getElementById('getLeadButton');
    const leadDetailsContainer = document.getElementById('leadDetailsContainer');
    const leadLoading = document.getElementById('leadLoading');
    const leadCardContainer = document.getElementById('leadCardContainer');
    const callButton = document.getElementById('callButton');
    const whatsappButton = document.getElementById('whatsappButton');
    const leadWhatsappTemplateBtn = document.getElementById('leadWhatsappTemplateBtn');
const leadWhatsappTemplateDropdown = document.getElementById('leadWhatsappTemplateDropdown');
    const leadNotes = document.getElementById('leadNotes');
    const leadStage = document.getElementById('leadStage');
    const callLaterDateContainer = document.getElementById('callLaterDateContainer');
    const callLaterDate = document.getElementById('callLaterDate');
    const trialDurationContainer = document.getElementById('trialDurationContainer');
    const durationHours = document.getElementById('durationHours');
    const durationMinutes = document.getElementById('durationMinutes');
    const durationSeconds = document.getElementById('durationSeconds');
    const submitLeadButton = document.getElementById('submitLeadButton');
    
    // Current lead tracking
    let currentLead = null;
    let leadHistory = [];
    let processingSubmission = false;
    let leadWhatsappDropdownVisible = false;
    
    // LocalStorage keys
    const CURRENT_LEAD_KEY = 'currentLead';
    const LEAD_HISTORY_KEY = 'leadHistory';
    const AGENT_CODE_KEY = 'agentCode';
    
    // Set today as min date for call later
    const today = new Date().toISOString().split('T')[0];
    callLaterDate.min = today;
    
    // Initialize WhatsApp template dropdown
    function initLeadWhatsAppTemplates() {
        // Clear existing options
        const leadWhatsappTemplateDropdown = document.getElementById('leadWhatsappTemplateDropdown');
    if (!leadWhatsappTemplateDropdown) return;
    
    leadWhatsappTemplateDropdown.innerHTML = '';
    
        
        
        // Add templates to dropdown
        WHATSAPP_TEMPLATES.forEach(template => {
        const option = document.createElement('div');
        option.className = 'template-option';
        option.dataset.id = template.id;
        option.dataset.message = template.message;
        
        option.innerHTML = `
            <span class="template-option-title">${template.title}</span>
            <span class="template-option-preview">${template.message.substring(0, 50)}${template.message.length > 50 ? '...' : ''}</span>
        `;
        
        option.addEventListener('click', function() {
            if (!currentLead || !currentLead.Phone) return;
            
            // Format phone with country code
            const phone = currentLead.Phone;
            const message = encodeURIComponent(this.dataset.message);
            
            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/91${phone}?text=${message}`;
            
            // Open in new tab
            window.open(whatsappUrl, '_blank');
            
            // Hide dropdown
            leadWhatsappTemplateDropdown.style.display = 'none';
            leadWhatsappDropdownVisible = false;
        });
        
        leadWhatsappTemplateDropdown.appendChild(option);
    });
}
    
    // Toggle WhatsApp template dropdown
    leadWhatsappTemplateBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!currentLead || !currentLead.Phone) {
        alert('No active lead to message');
        return;
    }
    
    if (leadWhatsappDropdownVisible) {
        leadWhatsappTemplateDropdown.style.display = 'none';
        leadWhatsappDropdownVisible = false;
    } else {
        leadWhatsappTemplateDropdown.style.display = 'block';
        leadWhatsappDropdownVisible = true;
    }
});
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
    if (leadWhatsappDropdownVisible && 
        !leadWhatsappTemplateDropdown.contains(e.target) && 
        e.target !== leadWhatsappTemplateBtn) {
        leadWhatsappTemplateDropdown.style.display = 'none';
        leadWhatsappDropdownVisible = false;
    }
});

// Lead Management Component - PART 3
    
    // Initialize the component
    function initLeadManagement() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem(AGENT_CODE_KEY);
        
        if (!agentCode) {
            document.querySelector('.lead-management-container').style.display = 'none';
            return;
        }
        
        // Initialize WhatsApp templates
        initLeadWhatsAppTemplates();
        
        // Check for saved lead and history
        checkForSavedLead();
    }
    
    // Check for saved lead in localStorage
    function checkForSavedLead() {
        const savedLead = localStorage.getItem(CURRENT_LEAD_KEY);
        const savedHistory = localStorage.getItem(LEAD_HISTORY_KEY);
        
        if (savedLead) {
            try {
                currentLead = JSON.parse(savedLead);
                
                if (savedHistory) {
                    leadHistory = JSON.parse(savedHistory);
                }
                
                displaySavedLead();
            } catch (e) {
                console.error('Error parsing saved lead:', e);
                localStorage.removeItem(CURRENT_LEAD_KEY);
                localStorage.removeItem(LEAD_HISTORY_KEY);
            }
        }
    }
    
    // Display a saved lead from localStorage
    function displaySavedLead() {
        if (!currentLead || !currentLead.Phone) return;
        
        // Show lead details
        leadDetailsContainer.style.display = 'block';
        leadLoading.style.display = 'none';
        leadCardContainer.innerHTML = '';
        
        // Create the current lead card
        const card = document.createElement('div');
        card.className = 'lead-card';
        card.innerHTML = `
            <div class="lead-card-header">
                <h3 class="lead-card-title">${currentLead.Source || 'Unknown Source'}</h3>
            </div>
            <div class="lead-card-content">
                <p><span class="lead-card-label">Phone:</span> ${currentLead.Phone}</p>
            </div>
        `;
        
        leadCardContainer.appendChild(card);
        
        // Add history header if we have history
        if (leadHistory && leadHistory.length > 0) {
            const historyHeader = document.createElement('div');
            historyHeader.className = 'lead-history-header';
            historyHeader.textContent = 'Lead History';
            leadCardContainer.appendChild(historyHeader);
            
            // Add each history item
            leadHistory.forEach((historyItem, index) => {
                if (index === 0) return; // Skip first item as it's the current lead
                
                const historyCard = document.createElement('div');
                historyCard.className = 'lead-card';
                historyCard.innerHTML = `
                    <div class="lead-card-header">
                        <h3 class="lead-card-title">${historyItem.Source || 'Unknown Source'}</h3>
                    </div>
                    <div class="lead-card-content">
                        <p><span class="lead-card-label">Phone:</span> ${historyItem.Phone}</p>
                    </div>
                `;
                
                leadCardContainer.appendChild(historyCard);
            });
        }
        
        // Setup action buttons
        setupActionButtons(currentLead.Phone);
    }
    
    // Event listener for get lead button
    getLeadButton.addEventListener('click', function() {
        // If already processing a lead, confirm before fetching a new one
        if (currentLead) {
            if (!confirm('You already have an active lead. Are you sure you want to get a new lead?')) {
                return;
            }
        }
        
        getNewLead();
    });
    
    // Handle lead stage select change
    leadStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle visibility of call later date picker
        if (selectedStage === 'Call Later') {
            callLaterDateContainer.style.display = 'block';
        } else {
            callLaterDateContainer.style.display = 'none';
        }
        
        // Toggle visibility of trial duration picker
        if (selectedStage === 'Trial Attended') {
            trialDurationContainer.style.display = 'block';
        } else {
            trialDurationContainer.style.display = 'none';
        }
        
        // Require notes for Not Interested
        if (selectedStage === 'Not Interested') {
            leadNotes.setAttribute('required', 'required');
            leadNotes.placeholder = 'Notes are required for Not Interested status...';
        } else {
            leadNotes.removeAttribute('required');
            leadNotes.placeholder = 'Add notes about this lead...';
        }
    });
    
    // Handle submit lead button
    submitLeadButton.addEventListener('click', function() {
        if (!currentLead) {
            alert('No lead selected');
            return;
        }
        
        // Prevent double submission
        if (processingSubmission) {
            return;
        }
        
        const selectedStage = leadStage.value;
        const notes = leadNotes.value;
        
        if (!selectedStage) {
            alert('Please select a disposition stage');
            return;
        }
        
        // Check if notes are required for Not Interested
        if (selectedStage === 'Not Interested' && (!notes || notes.trim() === '')) {
            alert('Notes are required for Not Interested status');
            return;
        }
        
        // Check if date is selected for Call Later
        if (selectedStage === 'Call Later' && !callLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Set processing flag
        processingSubmission = true;
        submitLeadButton.disabled = true;
        submitLeadButton.textContent = 'Processing...';
        
        // Process lead based on disposition stage
        processLead(selectedStage, notes);
    });
    
    // Setup action buttons for call and whatsapp
    function setupActionButtons(phone) {
        if (!phone) return;
        
        // Set call button href
        callButton.href = `tel:${phone}`;
        
        // Set whatsapp button href (add country code 91 for India)
        whatsappButton.href = `https://wa.me/91${phone}`;
    }
    
    // Process lead based on disposition stage
    async function processLead(stage, notes) {
        if (!currentLead || !currentLead.Phone) {
            alert('Invalid lead data');
            resetProcessingState();
            return;
        }
        
        const agentCode = localStorage.getItem(AGENT_CODE_KEY);
        const agentName = localStorage.getItem('agentName');
        const phone = currentLead.Phone;
        const date = new Date().toISOString().split('T')[0]; // Today's date
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        const source = currentLead.Source || '';
        
        try {
            // Show loading
            leadLoading.style.display = 'flex';
            leadCardContainer.style.display = 'none';
            
            // Process based on stage
            switch(stage) {
                case 'No Response':
                    // Add to No Response table
                    await addToNoResponseTable(phone, agentCode, source, date, time);
                    
                    // Send to n8n webhook for No Response
                    await sendToWebhook('no_response', phone, agentCode, agentName, source, notes);
                    break;
                    
                case 'Not Interested':
                    // Check for notes
                    if (!notes || notes.trim() === '') {
                        alert('Notes are required for Not Interested status');
                        resetProcessingState();
                        leadLoading.style.display = 'none';
                        leadCardContainer.style.display = 'block';
                        return;
                    }
                    
                    // Add to Not Interested table
                    await addToNotInterestedTable(phone, agentCode, source, notes, date, time);
                    
                    // Send to n8n webhook for Not Interested
                    await sendToWebhook('not_interested', phone, agentCode, agentName, source, notes);
                    break;
                    
                case 'Trial Enrolled':
                    // Add to agent's table with Trial Enrolled stage
                    await addToAgentTable(phone, stage, notes, source);
                    
                    // Send to n8n webhook for Trial Enrolled
                    await sendToWebhook('trial_enrolled', phone, agentCode, agentName, source, notes);
                    break;
                    
                case 'Call Later':
                    const callbackDate = callLaterDate.value;
                    if (!callbackDate) {
                        alert('Please select a call back date');
                        resetProcessingState();
                        leadLoading.style.display = 'none';
                        leadCardContainer.style.display = 'block';
                        return;
                    }
                    
                    // Add to agent's table with Call Later stage and callback date
                    await addToAgentTable(phone, stage, notes, source, callbackDate);
                    break;
                    
                case 'Trial Attended':
                    const hours = parseInt(durationHours.value) || 0;
                    const minutes = parseInt(durationMinutes.value) || 0;
                    const seconds = parseInt(durationSeconds.value) || 0;
                    
                    // Format duration as HHhMMmSSs
                    const duration = `${hours}hr${minutes}min${seconds}sec`;
                    
                    // Add to agent's table with Trial Attended stage and duration
                    await addToAgentTable(phone, stage, notes, source, null, duration);
                    break;
                    
                default:
                    // For all other stages, just add to agent's table
                    await addToAgentTable(phone, stage, notes, source);
                    break;
            }
            
            // Reset form and clear current lead
            resetLeadForm();
            
            // Show success message
            leadLoading.style.display = 'none';
            leadCardContainer.innerHTML = `
                <div class="lead-card" style="border-left-color: #28a745;">
                    <div class="lead-card-content">
                        <p>Lead has been processed successfully!</p>
                        <p>Click "Get New Lead" to get another lead.</p>
                    </div>
                </div>
            `;
            leadCardContainer.style.display = 'block';
            
        } catch (error) {
            console.error('Error processing lead:', error);
            alert(`Error processing lead: ${error.message}`);
            leadLoading.style.display = 'none';
            leadCardContainer.style.display = 'block';
        } finally {
            resetProcessingState();
        }
    }
    
// Lead Management Component - PART 4
    
    // Reset the processing state
    function resetProcessingState() {
        processingSubmission = false;
        submitLeadButton.disabled = false;
        submitLeadButton.textContent = 'Submit';
    }
    
    // Get a new lead from the main table
    async function getNewLead() {
        const agentCode = localStorage.getItem(AGENT_CODE_KEY);
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Show loading and lead details container
        leadDetailsContainer.style.display = 'block';
        leadLoading.style.display = 'flex';
        leadCardContainer.innerHTML = '';
        
        try {
            // 1. Get the newest lead with agent='new'
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records?where=(Agent,eq,new)&sort=-Id&limit=1`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                leadLoading.style.display = 'none';
                leadCardContainer.innerHTML = `
                    <div class="lead-card">
                        <div class="lead-card-content">
                            <p>No new leads available. Please try again later.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Set current lead
            currentLead = data.list[0];
            const leadPhone = currentLead.Phone;
            
            // 2. Update the lead with agent name in the main table
            const formattedAgentName = agentCode.toLowerCase().replace(' ', '');
            await updateLeadAgent(currentLead.Id, formattedAgentName);
            
            // 3. Update all instances of this phone number with the agent name
            await updateAllInstancesOfPhone(leadPhone, formattedAgentName);
            
            // 4. Get lead history
            await getLeadHistory(leadPhone);
            
        } catch (error) {
            console.error('Error getting lead:', error);
            leadLoading.style.display = 'none';
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>Error getting lead: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Update lead agent in main table
    async function updateLeadAgent(leadId, agentName) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify([
                    {
                        Id: leadId.toString(),
                        Agent: agentName
                    }
                ])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update lead agent: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating lead agent:', error);
            throw error;
        }
    }
    
    // Update all instances of a phone number with the agent name
    async function updateAllInstancesOfPhone(phone, agentName) {
        try {
            // First, get all records with this phone number
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records?where=(Phone,eq,${phone})`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch phone records: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                return; // No records to update
            }
            
            // Prepare update data for all records
            const updateData = data.list.map(record => ({
                Id: record.Id.toString(),
                Agent: agentName
            }));
            
            // Update all records
            const updateResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(updateData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Failed to update phone records: ${updateResponse.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating all instances of phone:', error);
            throw error;
        }
    }
    
    // Get lead history by phone number
    async function getLeadHistory(phone) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records?where=(Phone,eq,${phone})&sort=-Id`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead history: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Store lead history
            leadHistory = data.list || [];
            
            // Save current lead and history to localStorage
            localStorage.setItem(CURRENT_LEAD_KEY, JSON.stringify(currentLead));
            localStorage.setItem(LEAD_HISTORY_KEY, JSON.stringify(leadHistory));
            
            // Hide loading
            leadLoading.style.display = 'none';
            
            // Display lead and history
            displayLeadAndHistory();
            
        } catch (error) {
            console.error('Error getting lead history:', error);
            leadLoading.style.display = 'none';
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>Error getting lead history: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Display lead and history
    function displayLeadAndHistory() {
        if (!currentLead || !currentLead.Phone) {
            leadCardContainer.innerHTML = `
                <div class="lead-card">
                    <div class="lead-card-content">
                        <p>No lead data available.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Clear container
        leadCardContainer.innerHTML = '';
        
        // Create the current lead card
        const card = document.createElement('div');
        card.className = 'lead-card';
        card.innerHTML = `
            <div class="lead-card-header">
                <h3 class="lead-card-title">${currentLead.Source || 'Unknown Source'}</h3>
            </div>
            <div class="lead-card-content">
                <p><span class="lead-card-label">Phone:</span> ${currentLead.Phone}</p>
            </div>
        `;
        
        leadCardContainer.appendChild(card);
        
        // Add history header if we have more than just the current lead
        if (leadHistory && leadHistory.length > 1) {
            const historyHeader = document.createElement('div');
            historyHeader.className = 'lead-history-header';
            historyHeader.textContent = 'Lead History';
            leadCardContainer.appendChild(historyHeader);
            
            // Add history items (skip the first one which is the current lead)
            for (let i = 1; i < leadHistory.length; i++) {
                const historyItem = leadHistory[i];
                
                const historyCard = document.createElement('div');
                historyCard.className = 'lead-card';
                historyCard.innerHTML = `
                    <div class="lead-card-header">
                        <h3 class="lead-card-title">${historyItem.Source || 'Unknown Source'}</h3>
                    </div>
                    <div class="lead-card-content">
                        <p><span class="lead-card-label">Phone:</span> ${historyItem.Phone}</p>
                    </div>
                `;
                
                leadCardContainer.appendChild(historyCard);
            }
        }
        
        // Setup action buttons
        setupActionButtons(currentLead.Phone);
    }
    
    // Add lead to No Response table
    async function addToNoResponseTable(phone, agentCode, source, date, time) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${NO_RESPONSE_TABLE_ID}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify({
                    Phone: phone,
                    Agent: agentCode,
                    Source: source,
                    Date: date,
                    Time: time
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to No Response table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to No Response table:', error);
            throw error;
        }
    }
    
    // Add lead to Not Interested table
    async function addToNotInterestedTable(phone, agentCode, source, notes, date, time) {
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${NOT_INTERESTED_TABLE_ID}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify({
                    Phone: phone,
                    Agent: agentCode,
                    Source: source,
                    Notes: notes,
                    Date: date,
                    Time: time
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to Not Interested table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to Not Interested table:', error);
            throw error;
        }
    }
    
    // Add lead to agent's table
    async function addToAgentTable(phone, stage, notes, source, callbackDate = null, duration = null) {
        const agentCode = localStorage.getItem(AGENT_CODE_KEY);
        const agentTableId = TABLE_IDS[agentCode];
        
        if (!agentTableId) {
            throw new Error(`Table ID not found for ${agentCode}`);
        }
        
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        // Prepare data to add to agent's table
        const data = {
            Phone: phone,
            Date: callbackDate || today,
            Time: time,
            Notes: notes || '',
            "Lead Stage": stage,
            Source: source || 'Unknown Source'
        };
        
        // Add duration if provided (for Trial Attended)
        if (duration) {
            data.Duration = duration;
        }
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${agentTableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to agent table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to agent table:', error);
            throw error;
        }
    }
    
    // Send data to n8n webhook
    async function sendToWebhook(type, phone, agentCode, agentName, source = '', notes = '') {
        const webhookUrl = WEBHOOKS[type];
        
        if (!webhookUrl) {
            console.warn(`No webhook URL defined for type: ${type}`);
            return false;
        }
        
        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phone,
                    agent: agentCode,
                    agentName: agentName, // Added agent name for the webhook
                    source: source,
                    notes: notes,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to send to webhook: ${response.statusText}`);
            }
            
            console.log(`Successfully sent to ${type} webhook`);
            return true;
        } catch (error) {
            console.error(`Error sending to ${type} webhook:`, error);
            throw error;
        }
    }
    
    // Reset lead form
    function resetLeadForm() {
        leadNotes.value = '';
        leadStage.value = '';
        callLaterDate.value = '';
        durationHours.value = '0';
        durationMinutes.value = '0';
        durationSeconds.value = '0';
        callLaterDateContainer.style.display = 'none';
        trialDurationContainer.style.display = 'none';
        
        // Clear current lead and lead history from localStorage
        localStorage.removeItem(CURRENT_LEAD_KEY);
        localStorage.removeItem(LEAD_HISTORY_KEY);
        
        // Reset current lead and history
        currentLead = null;
        leadHistory = [];
    }
    
    // Add event listeners for login/logout
    document.addEventListener('agentLoggedIn', function() {
        setTimeout(initLeadManagement, 100);
    });
    
    // Initialize on page load
    window.addEventListener('load', function() {
        initLeadManagement();
    });
});
</script>
        
        <div class="section-divider"></div>
        
        <!-- Not My Lead Section - Only visible after login -->
        <div id="notMyLeadSection" class="crm-section" style="display: none;">
            <!-- Not My Lead Component will be inserted here -->

<!-- Not My Lead Component -->
<div class="card not-my-lead-container">
    <div class="card-header">
        <h2>Not My Lead</h2>
    </div>
    <div class="card-body">
        <p class="section-description">Use this section when a lead belongs to another agent.</p>
        
        <button id="startTransferButton" class="btn btn-primary btn-block">Start Transfer</button>
        
        <div class="not-my-lead-form" style="display: none;">
            <div class="form-group">
                <label for="transferPhone">Lead Phone Number:</label>
                <input type="tel" id="transferPhone" class="form-control" placeholder="Enter 10 digit phone number" pattern="[0-9]{10}" maxlength="10">
            </div>
            
            <div class="form-group">
                <label for="transferToAgent">Transfer To Agent:</label>
                <select id="transferToAgent" class="form-control">
                    <option value="" disabled selected>Select agent</option>
                    <option value="Agent 1">Agent 1</option>
                    <option value="Agent 2">Agent 2</option>
                    <option value="Agent 3">Agent 3</option>
                    <option value="Agent 4">Agent 4</option>
                    <option value="Agent 5">Agent 5</option>
                    <option value="Agent 6">Agent 6</option>
                    <option value="Agent 7">Agent 7</option>
                    <option value="Agent 8">Agent 8</option>
                    <option value="Agent 9">Agent 9</option>
                    <option value="Agent 10">Agent 10</option>
                    <option value="Agent 11">Agent 11</option>
                    <option value="Agent 12">Agent 12</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="transferLeadStage">Lead Stage:</label>
                <select id="transferLeadStage" class="form-control">
                    <option value="" disabled selected>Select lead stage</option>
                    <option value="Transfer">Transfer</option>
                    <option value="App Done">App Done</option>
                    <option value="Trial Enrolled">Trial Enrolled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="transferNotes">Notes:</label>
                <textarea id="transferNotes" class="form-control" rows="3" placeholder="Add notes about this transfer..."></textarea>
            </div>
            
            <button id="transferLeadButton" class="btn btn-primary btn-block">Transfer Lead</button>
        </div>
        
        <div id="transferLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Processing transfer...</p>
        </div>
        
        <div id="transferSuccess" class="success-message" style="display: none;">
            <div class="success-icon">✓</div>
            <p>Lead successfully transferred!</p>
            <button id="transferReset" class="btn btn-primary">Transfer Another Lead</button>
        </div>
    </div>
</div>

<style>
/* Not My Lead specific styles */
.section-description {
    margin-bottom: 1.5rem;
    color: var(--gray-color);
    font-size: 0.95rem;
}

.loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.success-message {
    text-align: center;
    padding: 2rem 0;
}

.success-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--success-color);
    color: white;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

#startTransferButton {
    margin-bottom: 1.5rem;
}

.not-my-lead-form {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs
    const TABLE_IDS = {
        'main': 'mxrl7syu0qe3xu3',
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const startTransferButton = document.getElementById('startTransferButton');
    const transferForm = document.querySelector('.not-my-lead-form');
    const transferPhone = document.getElementById('transferPhone');
    const transferToAgent = document.getElementById('transferToAgent');
    const transferLeadStage = document.getElementById('transferLeadStage');
    const transferNotes = document.getElementById('transferNotes');
    const transferLeadButton = document.getElementById('transferLeadButton');
    const transferLoading = document.getElementById('transferLoading');
    const transferSuccess = document.getElementById('transferSuccess');
    const transferReset = document.getElementById('transferReset');
    
    // Initialize the component
    function initNotMyLead() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.not-my-lead-container').style.display = 'none';
            return;
        }
        
        // Prevent agent from transferring to themselves
        const options = transferToAgent.querySelectorAll('option');
        options.forEach(option => {
            if (option.value === agentCode) {
                option.disabled = true;
            }
        });
    }
    
    // Start transfer button click
    startTransferButton.addEventListener('click', function() {
        // Show the transfer form
        transferForm.style.display = 'block';
        this.style.display = 'none';
        
        // Check if there's a current lead from Lead Management
        const savedLead = localStorage.getItem('currentLead');
        if (savedLead) {
            try {
                const currentLead = JSON.parse(savedLead);
                if (currentLead && currentLead.Phone) {
                    transferPhone.value = currentLead.Phone;
                }
            } catch (e) {
                console.error('Error parsing saved lead:', e);
            }
        }
        
        // Focus on the phone input
        transferPhone.focus();
    });
    
    // Transfer lead button click
    transferLeadButton.addEventListener('click', function() {
        // Validate form
        const phoneNumber = transferPhone.value;
        const targetAgent = transferToAgent.value;
        const leadStage = transferLeadStage.value;
        const notes = transferNotes.value;
        
        if (!phoneNumber || phoneNumber.length !== 10 || !/^\d+$/.test(phoneNumber)) {
            alert('Please enter a valid 10 digit phone number');
            return;
        }
        
        if (!targetAgent) {
            alert('Please select an agent to transfer to');
            return;
        }
        
        if (!leadStage) {
            alert('Please select a lead stage');
            return;
        }
        
        // Process the transfer
        transferLead(phoneNumber, targetAgent, leadStage, notes);
    });
    
    // Reset transfer form button
    transferReset.addEventListener('click', function() {
        // Reset the form and show the start button again
        transferSuccess.style.display = 'none';
        transferForm.style.display = 'none';
        startTransferButton.style.display = 'block';
        
        // Clear form fields
        transferPhone.value = '';
        transferToAgent.value = '';
        transferLeadStage.value = '';
        transferNotes.value = '';
    });
    
    // Transfer lead to another agent
    async function transferLead(phone, targetAgent, leadStage, notes) {
        const sourceAgent = localStorage.getItem('agentCode');
        const sourceAgentName = localStorage.getItem('agentName');
        
        if (!sourceAgent) {
            alert('Please login first');
            return;
        }
        
        // Show loading
        transferForm.style.display = 'none';
        transferLoading.style.display = 'flex';
        transferSuccess.style.display = 'none';
        
        try {
            // 1. Update all instances of this phone in the main table with the new agent
            await updateMainTableAgent(phone, targetAgent);
            
            // 2. Add the lead to the target agent's table with the selected stage
            await addToAgentTable(phone, targetAgent, leadStage, notes);
            
            // 3. If this is the current lead in Lead Management, clear it
            const savedLead = localStorage.getItem('currentLead');
            if (savedLead) {
                try {
                    const currentLead = JSON.parse(savedLead);
                    if (currentLead && currentLead.Phone === phone) {
                        localStorage.removeItem('currentLead');
                        localStorage.removeItem('leadHistory');
                    }
                } catch (e) {
                    console.error('Error checking current lead:', e);
                }
            }
            
            // Show success message
            transferLoading.style.display = 'none';
            transferSuccess.style.display = 'block';
            
        } catch (error) {
            console.error('Error transferring lead:', error);
            alert(`Error transferring lead: ${error.message}`);
            
            // Hide loading and show form again
            transferLoading.style.display = 'none';
            transferForm.style.display = 'block';
        }
    }
    
    // Update all instances of a phone number in the main table with a new agent
    async function updateMainTableAgent(phone, targetAgent) {
        try {
            // First, get all records with this phone number
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records?where=(Phone,eq,${phone})`, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead records: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                return; // No records to update
            }
            
            // Format target agent name for DB (lowercase, no spaces)
            const targetAgentName = targetAgent.toLowerCase().replace(' ', '');
            
            // Prepare update data for all records
            const updateData = data.list.map(record => ({
                Id: record.Id.toString(),
                Agent: targetAgentName
            }));
            
            // Update all records
            const updateResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${TABLE_IDS.main}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(updateData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Failed to update lead records: ${updateResponse.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating main table agent:', error);
            throw error;
        }
    }
    
    // Add lead to target agent's table
    async function addToAgentTable(phone, targetAgent, leadStage, notes) {
        // Get target agent's table ID
        const agentTableId = TABLE_IDS[targetAgent];
        
        if (!agentTableId) {
            throw new Error(`Table ID not found for ${targetAgent}`);
        }
        
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        // Source for transfer (who transferred it)
        const sourceAgentName = localStorage.getItem('agentName');
        const source = `Transfer from ${sourceAgentName || localStorage.getItem('agentCode')}`;
        
        // Prepare data to add to agent's table
        const data = {
            Phone: phone,
            Date: today,
            Time: time,
            Source: source,
            Notes: notes || '',
            "Lead Stage": leadStage
        };
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${agentTableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add to agent table: ${response.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error adding to agent table:', error);
            throw error;
        }
    }
    
    // Initialize on DOM content loaded
    initNotMyLead();
});
</script>

        </div>
        
        <div class="section-divider"></div>
        
        <!-- Add New Client Section - Only visible after login -->
        <div id="addNewClientSection" class="crm-section" style="display: none;">
            <!-- Add New Client Component will be inserted here -->

            <!-- Add New Client Component -->
<div class="card add-new-client-container">
    <div class="card-header">
        <h2>Add New Client</h2>
    </div>
    <div class="card-body">
        <p class="section-description">Add new leads from external sources or referrals.</p>
        
        <button id="addNewClientButton" class="btn btn-primary btn-block">Add New Client</button>
        
        <div id="addNewClientForm" class="add-new-client-form" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label for="newClientDate">Date:</label>
                    <input type="date" id="newClientDate" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="newClientTime">Time:</label>
                    <input type="time" id="newClientTime" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label for="newClientPhone">Phone Number:</label>
                <input type="tel" id="newClientPhone" class="form-control" placeholder="Enter 10 digit phone number" pattern="[0-9]{10}" maxlength="10">
            </div>
            
            <div class="form-group">
                <label for="newClientSource">Source:</label>
                <input type="text" id="newClientSource" class="form-control" placeholder="e.g., Referral, Website, etc.">
            </div>
            
            <div class="form-group">
                <label for="newClientStage">Lead Stage:</label>
                <select id="newClientStage" class="form-control">
                    <option value="" disabled selected>Select lead stage</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Transfer">Transfer</option>
                    <option value="App Pending">App Pending</option>
                    <option value="App Done">App Done</option>
                    <option value="Trial Enrolled">Trial Enrolled</option>
                    <option value="Trial Attended">Trial Attended</option>
                    <option value="Call Later">Call Later</option>
                    <option value="Paid">Paid</option>
                </select>
            </div>
            
            <!-- Call Later date picker (hidden by default) -->
            <div id="newClientCallLaterContainer" class="form-group" style="display: none;">
                <label for="newClientCallLaterDate">Call Back Date:</label>
                <input type="date" id="newClientCallLaterDate" class="form-control">
            </div>
            
            <!-- Trial Attended duration picker (hidden by default) -->
            <div id="newClientDurationContainer" class="form-group" style="display: none;">
                <label>Trial Duration:</label>
                <div class="duration-picker">
                    <div class="duration-field">
                        <input type="number" id="newClientDurationHours" class="form-control" min="0" max="23" value="0">
                        <label>Hours</label>
                    </div>
                    <div class="duration-field">
                        <input type="number" id="newClientDurationMinutes" class="form-control" min="0" max="59" value="0">
                        <label>Minutes</label>
                    </div>
                    <div class="duration-field">
                        <input type="number" id="newClientDurationSeconds" class="form-control" min="0" max="59" value="0">
                        <label>Seconds</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="newClientNotes">Notes:</label>
                <textarea id="newClientNotes" class="form-control" rows="3" placeholder="Add notes about this client..."></textarea>
            </div>
            
            <button id="submitNewClientButton" class="btn btn-primary btn-block">Submit New Client</button>
        </div>
        
        <div id="addNewClientLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Adding new client...</p>
        </div>
        
        <div id="addNewClientSuccess" class="success-message" style="display: none;">
            <div class="success-icon">✓</div>
            <p>Client successfully added!</p>
        </div>
    </div>
</div>

<style>
/* Add New Client specific styles */
.add-new-client-form {
    margin-top: 1.5rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.success-message {
    text-align: center;
    padding: 2rem 0;
}

.success-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--success-color);
    color: white;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -0.5rem;
    margin-left: -0.5rem;
}

.form-row > .form-group {
    flex: 1;
    padding: 0 0.5rem;
    min-width: 200px;
}

.duration-picker {
    display: flex;
    gap: 0.5rem;
}

.duration-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.duration-field label {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

@media (max-width: 576px) {
    .form-row {
        flex-direction: column;
    }
    
    .form-row > .form-group {
        width: 100%;
        padding: 0;
    }
    
    .duration-picker {
        flex-direction: column;
        gap: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs
    const TABLE_IDS = {
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const addNewClientButton = document.getElementById('addNewClientButton');
    const addNewClientForm = document.getElementById('addNewClientForm');
    const newClientDate = document.getElementById('newClientDate');
    const newClientTime = document.getElementById('newClientTime');
    const newClientPhone = document.getElementById('newClientPhone');
    const newClientSource = document.getElementById('newClientSource');
    const newClientStage = document.getElementById('newClientStage');
    const newClientCallLaterContainer = document.getElementById('newClientCallLaterContainer');
    const newClientCallLaterDate = document.getElementById('newClientCallLaterDate');
    const newClientDurationContainer = document.getElementById('newClientDurationContainer');
    const newClientDurationHours = document.getElementById('newClientDurationHours');
    const newClientDurationMinutes = document.getElementById('newClientDurationMinutes');
    const newClientDurationSeconds = document.getElementById('newClientDurationSeconds');
    const newClientNotes = document.getElementById('newClientNotes');
    const submitNewClientButton = document.getElementById('submitNewClientButton');
    const addNewClientLoading = document.getElementById('addNewClientLoading');
    const addNewClientSuccess = document.getElementById('addNewClientSuccess');
    
    // Set default values
    const today = new Date().toISOString().split('T')[0];
    newClientDate.value = today;
    newClientDate.min = "2023-01-01"; // Allow past dates
    
    const now = new Date();
    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    newClientTime.value = currentTime;
    
    newClientCallLaterDate.min = today;
    
    // Add New Client button click
    addNewClientButton.addEventListener('click', function() {
        addNewClientButton.style.display = 'none';
        addNewClientForm.style.display = 'block';
        addNewClientSuccess.style.display = 'none';
        
        // Focus on phone field
        newClientPhone.focus();
    });
    
    // Handle lead stage select change
    newClientStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle visibility of call later date picker
        if (selectedStage === 'Call Later') {
            newClientCallLaterContainer.style.display = 'block';
        } else {
            newClientCallLaterContainer.style.display = 'none';
        }
        
        // Toggle visibility of trial duration picker
        if (selectedStage === 'Trial Attended') {
            newClientDurationContainer.style.display = 'block';
        } else {
            newClientDurationContainer.style.display = 'none';
        }
    });
    
    // Submit New Client button click
    submitNewClientButton.addEventListener('click', function() {
        // Validate form
        const phone = newClientPhone.value;
        const stage = newClientStage.value;
        const date = newClientDate.value;
        const time = newClientTime.value;
        const source = newClientSource.value;
        
        if (!phone || phone.length !== 10 || !/^\d+$/.test(phone)) {
            alert('Please enter a valid 10 digit phone number');
            return;
        }
        
        if (!stage) {
            alert('Please select a lead stage');
            return;
        }
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        if (!time) {
            alert('Please enter a time');
            return;
        }
        
        if (!source) {
            alert('Please enter a source');
            return;
        }
        
        // Additional validation for specific stages
        if (stage === 'Call Later' && !newClientCallLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Add the new client
        addNewClient();
    });
    
    // Add new client to agent's table
    async function addNewClient() {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        addNewClientForm.style.display = 'none';
        addNewClientLoading.style.display = 'flex';
        addNewClientSuccess.style.display = 'none';
        
        // Gather form data
        const phone = newClientPhone.value;
        const stage = newClientStage.value;
        const date = stage === 'Call Later' ? newClientCallLaterDate.value : newClientDate.value;
        const time = newClientTime.value;
        const source = newClientSource.value;
        const notes = newClientNotes.value;
        
        // Prepare duration if Trial Attended
        let duration = null;
        if (stage === 'Trial Attended') {
            const hours = parseInt(newClientDurationHours.value) || 0;
            const minutes = parseInt(newClientDurationMinutes.value) || 0;
            const seconds = parseInt(newClientDurationSeconds.value) || 0;
            
            // Format duration as HHhMMmSSs
            duration = `${hours}hr${minutes}min${seconds}sec`;
        }
        
        // Prepare data to add to agent's table
        const data = {
            Phone: phone,
            Date: date,
            Time: time,
            Source: source,
            Notes: notes || '',
            "Lead Stage": stage
        };
        
        // Add duration if provided
        if (duration) {
            data.Duration = duration;
        }
        
        try {
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to add new client: ${response.statusText}`);
            }
            
            // Show success message
            addNewClientLoading.style.display = 'none';
            addNewClientSuccess.style.display = 'block';
            
            // Reset form
            setTimeout(resetNewClientForm, 2000);
            
        } catch (error) {
            console.error('Error adding new client:', error);
            alert(`Error adding new client: ${error.message}`);
            
            // Hide loading and show form again
            addNewClientLoading.style.display = 'none';
            addNewClientForm.style.display = 'block';
        }
    }
    
    // Reset new client form
    function resetNewClientForm() {
        // Reset form fields
        newClientPhone.value = '';
        newClientStage.value = '';
        newClientSource.value = '';
        newClientNotes.value = '';
        
        // Reset date and time to current
        const now = new Date();
        newClientDate.value = now.toISOString().split('T')[0];
        newClientTime.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        // Reset special fields
        newClientCallLaterDate.value = '';
        newClientDurationHours.value = '0';
        newClientDurationMinutes.value = '0';
        newClientDurationSeconds.value = '0';
        
        // Hide special containers
        newClientCallLaterContainer.style.display = 'none';
        newClientDurationContainer.style.display = 'none';
        
        // Hide form and success message, show add button
        addNewClientForm.style.display = 'none';
        addNewClientSuccess.style.display = 'none';
        addNewClientButton.style.display = 'block';
    }
    
    // Initialize component
    function initAddNewClient() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.add-new-client-container').style.display = 'none';
        }
    }
    
    // Initialize on DOM content loaded
    initAddNewClient();
});
</script>

        </div>
        
        <div class="section-divider"></div>
        
        <!-- My Client Details Section - Only visible after login -->
        <div id="myClientDetailsSection" class="crm-section" style="display: none;">
            <!-- My Client Details Component will be inserted here -->

            <!-- My Client Details Component -->
<div class="card my-client-details-container">
    <div class="card-header">
        <h2>My Client Details</h2>
    </div>
    <div class="card-body">
        <p class="section-description">View and manage your client leads by date and stage.</p>
        
        <div class="client-filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="myClientFilterDate">Select Date:</label>
                    <input type="date" id="myClientFilterDate" class="form-control">
                </div>
                
                <div class="form-group date-option">
                    <input type="checkbox" id="myClientFilterAll" class="form-check-input">
                    <label for="myClientFilterAll" class="form-check-label">All Dates</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="myClientFilterStage">Select Lead Stage:</label>
                <select id="myClientFilterStage" class="form-control">
                    <option value="" disabled selected>Select stage</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Transfer">Transfer</option>
                    <option value="App Pending">App Pending</option>
                    <option value="App Done">App Done</option>
                    <option value="Trial Enrolled">Trial Enrolled</option>
                    <option value="Trial Attended">Trial Attended</option>
                    <option value="Call Later">Call Later</option>
                    <option value="Paid">Paid</option>
                    <option value="No Response">No Response</option>
                    <option value="Not Interested">Not Interested</option>
                </select>
            </div>
            
            <button id="myClientFilterButton" class="btn btn-primary btn-block">View Clients</button>
        </div>
        
        <div id="myClientLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Loading client details...</p>
        </div>
        
        <div id="myClientResults" class="client-results" style="display: none;">
            <div class="results-header">
                <h3 id="myClientResultsTitle">Client Results</h3>
                <span id="myClientResultsCount" class="results-count">0 clients found</span>
            </div>
            
            <div id="myClientCardContainer" class="client-card-container">
                <!-- Client cards will be inserted here dynamically -->
            </div>
            
            <div id="myClientNoClientsFound" class="no-results" style="display: none;">
                <p>No clients found matching your criteria.</p>
            </div>
        </div>
        
        <!-- Client Update Modal -->
        <div id="myClientUpdateModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Update Client</h3>
                    <span id="myClientCloseModal" class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="client-info-display">
                        <p><strong>Phone:</strong> <span id="myClientUpdatePhone"></span></p>
                        <p><strong>Current Stage:</strong> <span id="myClientUpdateCurrentStage"></span></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientUpdateDate">Update Date:</label>
                        <input type="date" id="myClientUpdateDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientUpdateStage">New Lead Stage:</label>
                        <select id="myClientUpdateStage" class="form-control">
                            <option value="" disabled selected>Select new stage</option>
                            <option value="WhatsApp">WhatsApp</option>
                            <option value="Transfer">Transfer</option>
                            <option value="App Pending">App Pending</option>
                            <option value="App Done">App Done</option>
                            <option value="Trial Enrolled">Trial Enrolled</option>
                            <option value="Trial Attended">Trial Attended</option>
                            <option value="Call Later">Call Later</option>
                            <option value="Paid">Paid</option>
                            <option value="No Response">No Response</option>
                            <option value="Not Interested">Not Interested</option>
                        </select>
                    </div>
                    
                    <!-- Trial Attended duration picker (hidden by default) -->
                    <div id="myClientUpdateTrialDurationContainer" class="form-group" style="display: none;">
                        <label>Update Trial Duration:</label>
                        <div class="duration-picker">
                            <div class="duration-field">
                                <input type="number" id="myClientUpdateDurationHours" class="form-control" min="0" max="23" value="0">
                                <label>Hours</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="myClientUpdateDurationMinutes" class="form-control" min="0" max="59" value="0">
                                <label>Minutes</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="myClientUpdateDurationSeconds" class="form-control" min="0" max="59" value="0">
                                <label>Seconds</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Call Later date picker (hidden by default) -->
                    <div id="myClientUpdateCallLaterDateContainer" class="form-group" style="display: none;">
                        <label for="myClientUpdateCallLaterDate">Select New Call Back Date:</label>
                        <input type="date" id="myClientUpdateCallLaterDate" class="form-control">
                    </div>
                    
                    <!-- Not Interested notes requirement message (hidden by default) -->
                    <div id="myClientNotInterestedNotesMessage" class="form-group text-danger" style="display: none;">
                        <p><strong>Note:</strong> Notes are required for Not Interested status</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientUpdateNotes">Update Notes:</label>
                        <textarea id="myClientUpdateNotes" class="form-control" rows="3" placeholder="Add or update notes..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button id="myClientUpdateButton" class="btn btn-primary btn-block">Update Client</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Client Transfer Modal -->
        <div id="myClientTransferModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Transfer Client</h3>
                    <span id="myClientCloseTransferModal" class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="client-info-display">
                        <p><strong>Phone:</strong> <span id="myClientTransferPhone"></span></p>
                        <p><strong>Current Stage:</strong> <span id="myClientTransferCurrentStage"></span></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientTransferToAgent">Transfer To Agent:</label>
                        <select id="myClientTransferToAgent" class="form-control">
                            <option value="" disabled selected>Select agent</option>
                            <option value="Agent 1">Agent 1</option>
                            <option value="Agent 2">Agent 2</option>
                            <option value="Agent 3">Agent 3</option>
                            <option value="Agent 4">Agent 4</option>
                            <option value="Agent 5">Agent 5</option>
                            <option value="Agent 6">Agent 6</option>
                            <option value="Agent 7">Agent 7</option>
                            <option value="Agent 8">Agent 8</option>
                            <option value="Agent 9">Agent 9</option>
                            <option value="Agent 10">Agent 10</option>
                            <option value="Agent 11">Agent 11</option>
                            <option value="Agent 12">Agent 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientTransferLeadStage">Lead Stage:</label>
                        <select id="myClientTransferLeadStage" class="form-control">
                            <option value="" disabled selected>Select lead stage</option>
                            <option value="Transfer">Transfer</option>
                            <option value="App Done">App Done</option>
                            <option value="Trial Enrolled">Trial Enrolled</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientTransferDate">Transfer Date:</label>
                        <input type="date" id="myClientTransferDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="myClientTransferNotes">Transfer Notes:</label>
                        <textarea id="myClientTransferNotes" class="form-control" rows="3" placeholder="Add notes about this transfer..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button id="myClientTransferButton" class="btn btn-primary btn-block">Transfer Client</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WhatsApp Template Dropdown -->
        <div id="myClientWhatsappTemplateDropdown" class="whatsapp-template-dropdown2">
            <!-- Template options will be dynamically inserted here -->
        </div>
    </div>
</div>

<style>
/* My Client Details specific styles */
.form-row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -0.5rem;
    margin-left: -0.5rem;
    align-items: flex-end;
}

.form-row > .form-group {
    flex: 1;
    padding: 0 0.5rem;
    min-width: 200px;
}

.date-option {
    display: flex;
    align-items: center;
    min-width: auto !important;
    margin-top: 1.5rem;
}

.form-check-input {
    margin-right: 0.5rem;
}

.form-check-label {
    margin-bottom: 0;
    cursor: pointer;
}

.client-filter-form {
    margin-bottom: 1.5rem;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.results-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.results-count {
    color: var(--gray-color);
    font-size: 0.9rem;
}

.client-card-container {
    margin: 1rem 0;
    max-height: 500px;
    overflow-y: auto;
}

.client-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
    position: relative;
}

.client-card-number {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: var(--light-gray);
    color: var(--gray-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.client-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.client-card-title {
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
}

.client-card-stage {
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-size: 0.8rem;
    color: white;
    background-color: var(--primary-color);
}

.stage-app-pending { background-color: var(--warning-color); }
.stage-app-done { background-color: var(--accent-color); }
.stage-trial-enrolled { background-color: var(--primary-color); }
.stage-trial-attended { background-color: var(--success-color); }
.stage-paid { background-color: #28a745; } /* Green for paid */
.stage-call-later { background-color: var(--gray-color); }
.stage-transfer { background-color: #17a2b8; } /* Teal for transfer */
.stage-whatsapp { background-color: #25D366; } /* WhatsApp green */
.stage-no-response { background-color: #dc3545; } /* Red for no response */
.stage-not-interested { background-color: #6c757d; } /* Gray for not interested */

.client-card-content {
    margin-bottom: 0.5rem;
}

.client-card-content p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
}

.client-card-label {
    font-weight: 500;
    color: var(--gray-color);
}

.client-card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.client-card-actions .btn {
    flex: 1;
    min-width: 90px;
}

.no-results {
    text-align: center;
    padding: 2rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
}

/* WhatsApp template dropdown styles */
.whatsapp-container2 {
    display: flex;
    flex: 1;
    position: relative;
}

.btn-whatsapp {
    flex: 1;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-whatsapp-template {
    width: 30px;
    padding: 0.25rem 0;
    background-color: #1da851;
    color: white;
    border-color: #1da851;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    cursor: pointer;
}

.btn-whatsapp-template:hover {
    background-color: #19914b;
}

.template-icon {
    display: inline-block;
    font-size: 10px;
}

.whatsapp-template-dropdown {
    position: fixed;
    z-index: 9999;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none;
    max-height: 300px;
    width: 250px;
    overflow-y: auto;
}

.template-option {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.template-option:last-child {
    border-bottom: none;
}

.template-option:hover {
    background-color: #f5f5f5;
}

.template-option-title {
    font-weight: 500;
    font-size: 0.95rem;
    display: block;
    margin-bottom: 0.25rem;
}

.template-option-preview {
    font-size: 0.8rem;
    color: var(--gray-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    width: 90%;
    max-width: 500px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: var(--primary-color);
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.close-modal {
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.client-info-display {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
}

.client-info-display p {
    margin: 0.25rem 0;
}

.modal-footer {
    padding: 1rem 1.5rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
}

.modal-footer .btn {
    margin-top: 0;
}

.text-danger {
    color: #dc3545;
}

@media (max-width: 576px) {
    .form-row {
        flex-direction: column;
    }
    
    .form-row > .form-group {
        width: 100%;
        padding: 0;
    }
    
    .date-option {
        margin-top: 0.5rem;
    }
    
    .client-card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .client-card-stage {
        margin-top: 0.5rem;
    }
    
    .client-card-actions {
        flex-direction: column;
    }
    
    .client-card-actions .btn {
        width: 100%;
    }
    
    .modal-content {
        width: 95%;
    }
}
</style>

<script>
// My Client Details Component
(function() {
    // Create a namespace for My Client Details component to avoid conflicts
    const MyClientDetails = {};
    
    // API Token
    MyClientDetails.API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs for No Response and Not Interested
    MyClientDetails.NO_RESPONSE_TABLE_ID = 'mwijnju0ilfa3t1';
    MyClientDetails.NOT_INTERESTED_TABLE_ID = 'mo8mtemqthpdnsl';
    
    // Webhook URLs
    MyClientDetails.WEBHOOKS = {
        'no_response': 'https://flow.tsblive.in/webhook/e463bcac-0a06-4611-95f2-c001fc9585fb',
        'not_interested': 'https://flow.tsblive.in/webhook/1a89cda4-a800-4a29-8689-27b2ed6963d8'
    };
    
    // WhatsApp Templates
    MyClientDetails.WHATSAPP_TEMPLATES = [
        
        { 
            id: 'tt_jnv', 
            title: 'TimeTable JNV', 
            message: '*नवोदय विद्यालय की कोचिंग क्लास सोमवार से शनिवार प्रतिदिन होती है।*\n\n🔭 *Reasoning:* 4:00 to 4:50 pm\n📐 *Maths:* 5:00 to 5:50 pm\n👨‍🎓 *Eng/Hindi:* 7:00 to 7:50 pm\n\n💡 *प्रतिदिन प्रैक्टिस टेस्ट:* 8:00 to 9:00 pm\n\n📚 प्रतिदिन सुबह *5 बजे से 6 बजे तक Spoken English* की क्लास होती है\n\n👉 सभी क्लास में *उपस्थित रहना अनिवार्य* है । अनुपस्थित रहने पर माता पिता को कॉल एवं मैसेज करके बताया जाएगा प्रतिदिन'
        },
        { 
            id: 'tt_sainik_6', 
            title: 'TimeTable Sainik 6,4', 
            message: '*Online Coaching for Sainik School are held daily from Monday to Saturday*\n\n🔭 *Science:* 5:00 to 5:50 PM\n📐 *Maths:* 6:00 to 7:30 PM\n👨‍🎓 *English:* 8:00 to 8:50 PM\n💡 *Daily Practice Test:* 9:00 to 10:30 PM\n\n🔭 *Reasoning:* 4:00 to 4:50 PM (Fri & Sat)\n\n📚 *Spoken English Class:* 5:00 to 6:00 AM daily\n\n👉 Attendance in all *classes is mandatory.* If absent, parents will be informed *via call and message* every day.'
        },
        { 
            id: 'tt_sainik_9', 
            title: 'TimeTable Sainik 9', 
            message: '*Online Coaching for Sainik Class 9 are held daily from Monday to Saturday*\n\n🔭 *English:* 5:00 to 5:50 PM\n⚛️ *Science:* 6:00 to 6:50 PM\n👨‍🎓 *Sst:* 7:00 to 7:50 PM\n📐 *Maths:* 8:15 to 9:30 PM\n💡 *Daily Practice Test:* 9:00 to 10:30 PM\n\n🔭 *Reasoning:* Every Sunday\n\n📚 *Spoken English Class:* 5:00 to 6:00 AM daily\n\n👉 Attendance in all *classes is mandatory.* If absent, parents will be informed *via call and message* every day.'
        },
        { 
            id: 'fees_structure', 
            title: 'Fees', 
            message: '🎯 *Online Coaching Fees Details*\n\n✅ 2 days *FREE Trial* (LIVE Class)\n👉 If you like it, get *1-week full access* for just *₹29* 💸\n\nIncludes:\n📖 Daily *LIVE* Classes\n📝 Daily *Tests* & Notes\n🎥 Recordings\n🗣️ *Spoken* English Class\n\nAfter 1 week, you can Join and *continue* if you’re happy 😊'
        },
        { 
            id: 'cutoff_sainik', 
            title: 'Sainik Cutoff', 
            message: '*Free Software for Sainik School*\n\n*For Class 6 and 9*\n\n📈 Cutoff Marks\n🎟️ Available Seats\n💰 Fees Detail\n\n*Click Here:* https://course.thespeedybrains.com/s/pages/sainik-school-cutoff-marks\n\nType *yes* if you are not able to click on link'
        },
        { 
            id: 'cutoff_jnv', 
            title: 'JNV Cutoff', 
            message: 'Cutoff Checker for JNV will be ready in a week.\n\nType *yes* if you are interested'
        },
        { 
            id: 'app_downlaod', 
            title: 'App Download', 
            message: '*The Speedy Brains Academy*\n\nBest App for *Sainik and Navodaya* Coaching\n\n*Click Here:* https://play.google.com/store/apps/details?id=com.thespeedybrains.learners'
        }
        
        
    ];
    
    // Table IDs
    MyClientDetails.TABLE_IDS = {
        'main': 'mxrl7syu0qe3xu3',
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements - Filter Section
    MyClientDetails.clientFilterDate = document.getElementById('myClientFilterDate');
    MyClientDetails.clientFilterAll = document.getElementById('myClientFilterAll');
    MyClientDetails.clientFilterStage = document.getElementById('myClientFilterStage');
    MyClientDetails.clientFilterButton = document.getElementById('myClientFilterButton');
    MyClientDetails.clientLoading = document.getElementById('myClientLoading');
    MyClientDetails.clientResults = document.getElementById('myClientResults');
    MyClientDetails.resultsTitle = document.getElementById('myClientResultsTitle');
    MyClientDetails.resultsCount = document.getElementById('myClientResultsCount');
    MyClientDetails.clientCardContainer = document.getElementById('myClientCardContainer');
    MyClientDetails.noClientsFound = document.getElementById('myClientNoClientsFound');
    
    // DOM Elements - Update Modal
    MyClientDetails.updateClientModal = document.getElementById('myClientUpdateModal');
    MyClientDetails.closeModal = document.getElementById('myClientCloseModal');
    MyClientDetails.updateClientPhone = document.getElementById('myClientUpdatePhone');
    MyClientDetails.updateClientCurrentStage = document.getElementById('myClientUpdateCurrentStage');
    MyClientDetails.updateClientDate = document.getElementById('myClientUpdateDate');
    MyClientDetails.updateClientStage = document.getElementById('myClientUpdateStage');
    MyClientDetails.updateTrialDurationContainer = document.getElementById('myClientUpdateTrialDurationContainer');
    MyClientDetails.updateDurationHours = document.getElementById('myClientUpdateDurationHours');
    MyClientDetails.updateDurationMinutes = document.getElementById('myClientUpdateDurationMinutes');
    MyClientDetails.updateDurationSeconds = document.getElementById('myClientUpdateDurationSeconds');
    MyClientDetails.updateCallLaterDateContainer = document.getElementById('myClientUpdateCallLaterDateContainer');
    MyClientDetails.updateCallLaterDate = document.getElementById('myClientUpdateCallLaterDate');
    MyClientDetails.notInterestedNotesMessage = document.getElementById('myClientNotInterestedNotesMessage');
    MyClientDetails.updateClientNotes = document.getElementById('myClientUpdateNotes');
    MyClientDetails.updateClientButton = document.getElementById('myClientUpdateButton');
    
    // DOM Elements - Transfer Modal
    MyClientDetails.transferClientModal = document.getElementById('myClientTransferModal');
    MyClientDetails.closeTransferModal = document.getElementById('myClientCloseTransferModal');
    MyClientDetails.transferClientPhone = document.getElementById('myClientTransferPhone');
    MyClientDetails.transferClientCurrentStage = document.getElementById('myClientTransferCurrentStage');
    MyClientDetails.transferToAgent = document.getElementById('myClientTransferToAgent');
    MyClientDetails.transferLeadStage = document.getElementById('myClientTransferLeadStage');
    MyClientDetails.transferDate = document.getElementById('myClientTransferDate');
    MyClientDetails.transferClientNotes = document.getElementById('myClientTransferNotes');
    MyClientDetails.transferClientButton = document.getElementById('myClientTransferButton');
    
    // DOM Elements - WhatsApp Template Dropdown
    MyClientDetails.whatsappTemplateDropdown = document.getElementById('myClientWhatsappTemplateDropdown');
    
    // Set today as default date
    MyClientDetails.today = new Date().toISOString().split('T')[0];
    if (MyClientDetails.clientFilterDate) MyClientDetails.clientFilterDate.value = MyClientDetails.today;
    if (MyClientDetails.updateClientDate) MyClientDetails.updateClientDate.min = "2023-01-01"; // Allow past dates for update
    if (MyClientDetails.transferDate) MyClientDetails.transferDate.value = MyClientDetails.today; // Set transfer date to today by default
    
    // Initialize min date for date pickers
    if (MyClientDetails.clientFilterDate) MyClientDetails.clientFilterDate.min = "2023-01-01"; // Set a reasonable min date
    if (MyClientDetails.updateCallLaterDate) MyClientDetails.updateCallLaterDate.min = MyClientDetails.today;
    
    // Track current client for updates/transfers
    MyClientDetails.currentClientId = null;
    MyClientDetails.currentClientData = null;
    
    // Initialize WhatsApp template dropdown
    MyClientDetails.initWhatsAppTemplates = function() {
        // Clear existing options
        if (!MyClientDetails.whatsappTemplateDropdown) return;
        
        MyClientDetails.whatsappTemplateDropdown.innerHTML = '';
        
        // Add templates to dropdown
        MyClientDetails.WHATSAPP_TEMPLATES.forEach(template => {
            const option = document.createElement('div');
            option.className = 'template-option';
            option.dataset.id = template.id;
            option.dataset.message = template.message;
            
            option.innerHTML = `
                <span class="template-option-title">${template.title}</span>
                <span class="template-option-preview">${template.message.substring(0, 50)}${template.message.length > 50 ? '...' : ''}</span>
            `;
            
            option.addEventListener('click', function() {
                // Get phone from data attribute (set when template button is clicked)
                const phone = this.dataset.phone;
                if (!phone) return;
                
                const message = encodeURIComponent(this.dataset.message);
                
                // Create WhatsApp URL
                const whatsappUrl = `https://wa.me/91${phone}?text=${message}`;
                
                // Open in new tab
                window.open(whatsappUrl, '_blank');
                
                // Hide dropdown
                MyClientDetails.whatsappTemplateDropdown.style.display = 'none';
            });
            
            MyClientDetails.whatsappTemplateDropdown.appendChild(option);
        });
    };
    
    // Event Listeners
    
    // Toggle date input based on "All" checkbox
    if (MyClientDetails.clientFilterAll) {
        MyClientDetails.clientFilterAll.addEventListener('change', function() {
            if (MyClientDetails.clientFilterDate) {
                MyClientDetails.clientFilterDate.disabled = this.checked;
            }
        });
    }
    
    // View clients button click
    if (MyClientDetails.clientFilterButton) {
        MyClientDetails.clientFilterButton.addEventListener('click', function() {
            const allDates = MyClientDetails.clientFilterAll && MyClientDetails.clientFilterAll.checked;
            const date = MyClientDetails.clientFilterDate && MyClientDetails.clientFilterDate.value;
            const stage = MyClientDetails.clientFilterStage && MyClientDetails.clientFilterStage.value;
            
            if (!allDates && !date) {
                alert('Please select a date or check "All Dates"');
                return;
            }
            
            if (!stage) {
                alert('Please select a lead stage');
                return;
            }
            
            // Fetch clients
            MyClientDetails.fetchClientsByStageAndDate(stage, allDates ? null : date);
        });
    }
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === MyClientDetails.updateClientModal) {
            MyClientDetails.updateClientModal.style.display = 'none';
        }
        
        if (event.target === MyClientDetails.transferClientModal) {
            MyClientDetails.transferClientModal.style.display = 'none';
        }
        
        // Close template dropdown when clicking outside
        if (MyClientDetails.whatsappTemplateDropdown && 
            MyClientDetails.whatsappTemplateDropdown.style.display === 'block' && 
            !event.target.closest('.template-toggle') && 
            !MyClientDetails.whatsappTemplateDropdown.contains(event.target)) {
            MyClientDetails.whatsappTemplateDropdown.style.display = 'none';
        }
    });
    
    // Close modals via X buttons
    if (MyClientDetails.closeModal) {
        MyClientDetails.closeModal.addEventListener('click', function() {
            MyClientDetails.updateClientModal.style.display = 'none';
        });
    }
    
    if (MyClientDetails.closeTransferModal) {
        MyClientDetails.closeTransferModal.addEventListener('click', function() {
            MyClientDetails.transferClientModal.style.display = 'none';
        });
    }
    
    // Toggle additional fields based on selected stage in update modal
    if (MyClientDetails.updateClientStage) {
        MyClientDetails.updateClientStage.addEventListener('change', function() {
            const selectedStage = this.value;
            
            // Hide all special containers first
            if (MyClientDetails.updateTrialDurationContainer) {
                MyClientDetails.updateTrialDurationContainer.style.display = 'none';
            }
            if (MyClientDetails.updateCallLaterDateContainer) {
                MyClientDetails.updateCallLaterDateContainer.style.display = 'none';
            }
            if (MyClientDetails.notInterestedNotesMessage) {
                MyClientDetails.notInterestedNotesMessage.style.display = 'none';
            }
            
            // Show relevant containers based on selection
            if (selectedStage === 'Trial Attended' && MyClientDetails.updateTrialDurationContainer) {
                MyClientDetails.updateTrialDurationContainer.style.display = 'block';
            } else if (selectedStage === 'Call Later' && MyClientDetails.updateCallLaterDateContainer) {
                MyClientDetails.updateCallLaterDateContainer.style.display = 'block';
            } else if (selectedStage === 'Not Interested' && MyClientDetails.notInterestedNotesMessage) {
                MyClientDetails.notInterestedNotesMessage.style.display = 'block';
            }
        });
    }
    
    // Update client button click
    if (MyClientDetails.updateClientButton) {
        MyClientDetails.updateClientButton.addEventListener('click', function() {
            if (!MyClientDetails.currentClientId) {
                alert('No client selected for update');
                return;
            }
            
            const phone = MyClientDetails.updateClientPhone.textContent;
            const newStage = MyClientDetails.updateClientStage.value;
            const notes = MyClientDetails.updateClientNotes.value;
            const newDate = MyClientDetails.updateClientDate.value;
            
            // Additional validation for specific stages
            if (newStage === 'Call Later' && !MyClientDetails.updateCallLaterDate.value) {
                alert('Please select a call back date');
                return;
            }
            
            if (newStage === 'Not Interested' && (!notes || notes.trim() === '')) {
                alert('Notes are required for Not Interested status');
                return;
            }
            
            // Process the update
            MyClientDetails.updateClient(MyClientDetails.currentClientId, phone, newStage, notes, newDate);
        });
    }
    
    // Transfer client button click
    if (MyClientDetails.transferClientButton) {
        MyClientDetails.transferClientButton.addEventListener('click', function() {
            if (!MyClientDetails.currentClientId) {
                alert('No client selected for transfer');
                return;
            }
            
            const phone = MyClientDetails.transferClientPhone.textContent;
            const targetAgent = MyClientDetails.transferToAgent.value;
            const leadStage = MyClientDetails.transferLeadStage.value;
            const selectedDate = MyClientDetails.transferDate.value;
            const notes = MyClientDetails.transferClientNotes.value;
            
            console.log("Transfer values:", {
                phone, 
                targetAgent, 
                targetAgentIndex: MyClientDetails.transferToAgent.selectedIndex,
                leadStage, 
                leadStageIndex: MyClientDetails.transferLeadStage.selectedIndex,
                selectedDate, 
                notes
            });
            
            // More explicit validation that checks selected index
            if (!targetAgent || MyClientDetails.transferToAgent.selectedIndex <= 0) {
                alert('Please select an agent to transfer to');
                return;
            }
            
            if (!leadStage || MyClientDetails.transferLeadStage.selectedIndex <= 0) {
                alert('Please select a lead stage');
                return;
            }
            
            if (!selectedDate) {
                alert('Please select a transfer date');
                return;
            }
            
            // Process the transfer
            MyClientDetails.transferClient(MyClientDetails.currentClientId, phone, targetAgent, leadStage, selectedDate, notes);
        });
    }
    
    // Fetch clients by stage and date
    MyClientDetails.fetchClientsByStageAndDate = async function(stage, date) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = MyClientDetails.TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        if (MyClientDetails.clientLoading) MyClientDetails.clientLoading.style.display = 'flex';
        if (MyClientDetails.clientResults) MyClientDetails.clientResults.style.display = 'none';
        if (MyClientDetails.clientCardContainer) MyClientDetails.clientCardContainer.innerHTML = '';
        if (MyClientDetails.noClientsFound) MyClientDetails.noClientsFound.style.display = 'none';
        
        try {
            // Construct the query URL
            let queryUrl = `https://nocodb.tsblive.in/api/v2/tables/${tableId}/records?sort=-Id`;
            
            // Add stage filter
            const leadStageParam = encodeURIComponent('Lead Stage');
            queryUrl += `&where=(${leadStageParam},eq,${encodeURIComponent(stage)})`;
            
            // Add date filter if provided
            if (date) {
                queryUrl += `~and(Date,eq,exactDate,${date})`;
            }
            
            const response = await fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'xc-token': MyClientDetails.API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch clients: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Display results
            MyClientDetails.displayClientResults(data.list, stage, date);
            
        } catch (error) {
            console.error('Error fetching clients:', error);
            if (MyClientDetails.clientLoading) MyClientDetails.clientLoading.style.display = 'none';
            alert(`Error fetching clients: ${error.message}`);
        }
    };
    
    // Display client results
    MyClientDetails.displayClientResults = function(clients, stage, date) {
        // Hide loading
        if (MyClientDetails.clientLoading) MyClientDetails.clientLoading.style.display = 'none';
        
        // Update results title and count
        if (MyClientDetails.resultsTitle) {
            MyClientDetails.resultsTitle.textContent = `Clients with Stage: ${stage}`;
            if (date) {
                MyClientDetails.resultsTitle.textContent += ` on ${MyClientDetails.formatDate(date)}`;
            }
        }
        
        if (!clients || clients.length === 0) {
            // Show no results
            if (MyClientDetails.noClientsFound) MyClientDetails.noClientsFound.style.display = 'block';
            if (MyClientDetails.resultsCount) MyClientDetails.resultsCount.textContent = '0 clients found';
            if (MyClientDetails.clientResults) MyClientDetails.clientResults.style.display = 'block';
            return;
        }
        
        // Update count
        if (MyClientDetails.resultsCount) MyClientDetails.resultsCount.textContent = `${clients.length} clients found`;
        
        // Clear container
        if (MyClientDetails.clientCardContainer) MyClientDetails.clientCardContainer.innerHTML = '';
        
        // Add each client as a card
        clients.forEach((client, index) => {
            const card = document.createElement('div');
            card.className = 'client-card';
            
            // Convert stage class (lowercase, replace spaces with hyphens)
            const stageClass = `stage-${(client['Lead Stage'] || '').toLowerCase().replace(/\s+/g, '-')}`;
            
            // Add serial number
            const serialNumber = document.createElement('div');
            serialNumber.className = 'client-card-number';
            serialNumber.textContent = index + 1;
            card.appendChild(serialNumber);
            
            card.innerHTML += `
                <div class="client-card-header">
                    <h3 class="client-card-title">${client.Phone || 'No Phone'}</h3>
                    <span class="client-card-stage ${stageClass}">${client['Lead Stage'] || 'Unknown'}</span>
                </div>
                <div class="client-card-content">
                    <p><span class="client-card-label">Date:</span> ${client.Date || 'N/A'}</p>
                    <p><span class="client-card-label">Source:</span> ${client.Source || 'N/A'}</p>
                    ${client.Duration ? `<p><span class="client-card-label">Duration:</span> ${client.Duration}</p>` : ''}
                    <p><span class="client-card-label">Notes:</span> ${client.Notes || 'No notes'}</p>
                </div>
                <div class="client-card-actions">
                    <a href="tel:${client.Phone}" class="btn btn-call">Call</a>
                    <div class="whatsapp-container2">
                        <a href="https://wa.me/91${client.Phone}" class="btn btn-whatsapp">WhatsApp</a>
                        <button class="btn btn-whatsapp-template template-toggle" data-phone="${client.Phone}">
                            <span class="template-icon">➤</span>
                        </button>
                    </div>
                    <button class="btn btn-primary update-client-btn" 
                            data-phone="${client.Phone}"
                            data-stage="${client['Lead Stage'] || ''}"
                            data-notes="${client.Notes || ''}"
                            data-id="${client.Id}"
                            data-date="${client.Date || MyClientDetails.today}"
                            data-duration="${client.Duration || ''}"
                            data-source="${client.Source || ''}">
                        Update
                    </button>
                    <button class="btn btn-primary transfer-client-btn" 
                            data-phone="${client.Phone}"
                            data-stage="${client['Lead Stage'] || ''}"
                            data-notes="${client.Notes || ''}"
                            data-id="${client.Id}"
                            data-source="${client.Source || ''}">
                        Start Transfer
                    </button>
                </div>
            `;
            
            if (MyClientDetails.clientCardContainer) MyClientDetails.clientCardContainer.appendChild(card);
        });
        
        // Add event listeners to buttons
        MyClientDetails.addEventListenersToClientCards();
        
        // Show results
        if (MyClientDetails.clientResults) MyClientDetails.clientResults.style.display = 'block';
    };
    
    // Add event listeners to client card buttons
    MyClientDetails.addEventListenersToClientCards = function() {
        // Update buttons
        const updateButtons = document.querySelectorAll('.update-client-btn');
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const phone = this.getAttribute('data-phone');
                const stage = this.getAttribute('data-stage');
                const notes = this.getAttribute('data-notes');
                const id = this.getAttribute('data-id');
                const date = this.getAttribute('data-date');
                const duration = this.getAttribute('data-duration');
                const source = this.getAttribute('data-source');
                
                MyClientDetails.openUpdateModal(phone, stage, notes, id, date, duration, source);
            });
        });
        
        // Transfer buttons
        const transferButtons = document.querySelectorAll('.transfer-client-btn');
        transferButtons.forEach(button => {
            button.addEventListener('click', function() {
                const phone = this.getAttribute('data-phone');
                const stage = this.getAttribute('data-stage');
                const notes = this.getAttribute('data-notes');
                const id = this.getAttribute('data-id');
                const source = this.getAttribute('data-source');
                
                MyClientDetails.openTransferModal(phone, stage, notes, id, source);
            });
        });
        
        // WhatsApp template buttons
        const templateButtons = document.querySelectorAll('.template-toggle');
        templateButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Get the phone number from data attribute
                const phone = this.getAttribute('data-phone');
                if (!phone) return;
                
                // Position dropdown relative to button
                const buttonRect = this.getBoundingClientRect();
                const dropdownWidth = 250; // From CSS
                
                // Calculate position (centered below button)
                const leftPosition = Math.max(10, buttonRect.left - (dropdownWidth / 2) + (buttonRect.width / 2));
                
                // Update dropdown options to use this phone number
                const options = MyClientDetails.whatsappTemplateDropdown.querySelectorAll('.template-option');
                options.forEach(option => {
                    option.dataset.phone = phone;
                });
                
                // Apply position
                MyClientDetails.whatsappTemplateDropdown.style.top = (buttonRect.bottom + window.scrollY + 5) + 'px'; // 5px gap
                MyClientDetails.whatsappTemplateDropdown.style.left = leftPosition + 'px';
                
                // Show dropdown
                MyClientDetails.whatsappTemplateDropdown.style.display = 'block';
            });
        });
    };
    
    // Open update modal
    MyClientDetails.openUpdateModal = function(phone, stage, notes, id, date, duration, source) {
        // Set values in modal
        if (MyClientDetails.updateClientPhone) MyClientDetails.updateClientPhone.textContent = phone;
        if (MyClientDetails.updateClientCurrentStage) MyClientDetails.updateClientCurrentStage.textContent = stage;
        if (MyClientDetails.updateClientNotes) MyClientDetails.updateClientNotes.value = notes;
        if (MyClientDetails.updateClientDate) MyClientDetails.updateClientDate.value = date || MyClientDetails.today;
        
        // Store current client data
        MyClientDetails.currentClientId = id;
        MyClientDetails.currentClientData = {
            phone: phone,
            stage: stage,
            notes: notes,
            date: date,
            duration: duration,
            source: source || ''
        };
        
        // Reset selections
        if (MyClientDetails.updateClientStage) MyClientDetails.updateClientStage.selectedIndex = 0;
        if (MyClientDetails.updateDurationHours) MyClientDetails.updateDurationHours.value = '0';
        if (MyClientDetails.updateDurationMinutes) MyClientDetails.updateDurationMinutes.value = '0';
        if (MyClientDetails.updateDurationSeconds) MyClientDetails.updateDurationSeconds.value = '0';
        if (MyClientDetails.updateCallLaterDate) MyClientDetails.updateCallLaterDate.value = '';
        if (MyClientDetails.notInterestedNotesMessage) MyClientDetails.notInterestedNotesMessage.style.display = 'none';
        
        // Hide conditional containers
        if (MyClientDetails.updateTrialDurationContainer) MyClientDetails.updateTrialDurationContainer.style.display = 'none';
        if (MyClientDetails.updateCallLaterDateContainer) MyClientDetails.updateCallLaterDateContainer.style.display = 'none';
        
        // Parse duration if available
        if (duration && MyClientDetails.updateDurationHours && MyClientDetails.updateDurationMinutes && MyClientDetails.updateDurationSeconds) {
            const durationMatch = duration.match(/(\d+)hr(\d+)min(\d+)sec/);
            if (durationMatch) {
                MyClientDetails.updateDurationHours.value = durationMatch[1];
                MyClientDetails.updateDurationMinutes.value = durationMatch[2];
                MyClientDetails.updateDurationSeconds.value = durationMatch[3];
            }
        }
        
        // Show modal
        if (MyClientDetails.updateClientModal) MyClientDetails.updateClientModal.style.display = 'block';
    };
    
    // Open transfer modal
    MyClientDetails.openTransferModal = function(phone, stage, notes, id, source) {
        // Set values in modal
        if (MyClientDetails.transferClientPhone) MyClientDetails.transferClientPhone.textContent = phone;
        if (MyClientDetails.transferClientCurrentStage) MyClientDetails.transferClientCurrentStage.textContent = stage;
        if (MyClientDetails.transferClientNotes) MyClientDetails.transferClientNotes.value = notes;
        if (MyClientDetails.transferDate) MyClientDetails.transferDate.value = MyClientDetails.today; // Set default date to today
        
        // Store current client data
        MyClientDetails.currentClientId = id;
        MyClientDetails.currentClientData = {
            phone: phone,
            stage: stage,
            notes: notes,
            source: source || ''
        };
        
        // Reset selections - explicitly set to first (disabled) option
        if (MyClientDetails.transferToAgent) MyClientDetails.transferToAgent.selectedIndex = 0;
        if (MyClientDetails.transferLeadStage) MyClientDetails.transferLeadStage.selectedIndex = 0;
        
        // Prevent agent from transferring to themselves
        const currentAgent = localStorage.getItem('agentCode');
        
        if (MyClientDetails.transferToAgent) {
            const options = MyClientDetails.transferToAgent.querySelectorAll('option');
            options.forEach(option => {
                if (option.value === currentAgent) {
                    option.disabled = true;
                } else {
                    option.disabled = option.value === "" || option.disabled; // Keep first option disabled
                }
            });
        }
        
        // Show modal
        if (MyClientDetails.transferClientModal) MyClientDetails.transferClientModal.style.display = 'block';
    };
    
    // Update client
    MyClientDetails.updateClient = async function(clientId, phone, newStage, notes, newDate) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        const tableId = MyClientDetails.TABLE_IDS[agentCode];
        
        if (!tableId || !clientId) {
            alert('Missing table ID or client ID');
            return;
        }
        
        // Show loading in modal
        if (MyClientDetails.updateClientButton) {
            MyClientDetails.updateClientButton.disabled = true;
            MyClientDetails.updateClientButton.textContent = 'Updating...';
        }
        
        try {
            // Get source if we need it for special tables
            if ((newStage === 'No Response' || newStage === 'Not Interested') && 
                !MyClientDetails.currentClientData.source) {
                // Fetch the client record to get the source
                const clientResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records/${clientId}`, {
                    method: 'GET',
                    headers: {
                        'xc-token': MyClientDetails.API_TOKEN
                    }
                });
                
                if (clientResponse.ok) {
                    const clientData = await clientResponse.json();
                    MyClientDetails.currentClientData.source = clientData.Source || '';
                }
            }
            
            // Handle special stages No Response and Not Interested first
            if (newStage === 'No Response' || newStage === 'Not Interested') {
                const webhookType = newStage === 'No Response' ? 'no_response' : 'not_interested';
                const specialTableId = newStage === 'No Response' ? 
                    MyClientDetails.NO_RESPONSE_TABLE_ID : 
                    MyClientDetails.NOT_INTERESTED_TABLE_ID;
                
                // 1. Add to special table
                const currentTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                const specialTableData = {
                    Phone: phone,
                    Agent: agentCode.toLowerCase().replace(' ', ''),
                    Source: MyClientDetails.currentClientData.source,
                    Date: newDate || MyClientDetails.today,
                    Time: currentTime
                };
                
                // Add notes for not interested
                if (newStage === 'Not Interested') {
                    specialTableData.Notes = notes;
                }
                
                // Add to special table
                const specialResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${specialTableId}/records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xc-token': MyClientDetails.API_TOKEN
                    },
                    body: JSON.stringify(specialTableData)
                });
                
                if (!specialResponse.ok) {
                    throw new Error(`Failed to add to ${newStage} table: ${specialResponse.statusText}`);
                }
                
                // 2. Send to webhook
                const agentName = localStorage.getItem('agentName');
                await MyClientDetails.sendToWebhook(
                    webhookType, 
                    phone, 
                    agentCode, 
                    agentName, 
                    MyClientDetails.currentClientData.source, 
                    notes
                );
            }
            
            // Continue with normal update to agent's table
            // Prepare update data
            const updateData = {
                Id: clientId
            };
            
            // Add date if changed
            if (newDate && newDate !== MyClientDetails.currentClientData.date) {
                updateData.Date = newDate;
            }
            
            // Add notes if provided or changed
            if (notes && notes !== MyClientDetails.currentClientData.notes) {
                updateData.Notes = notes;
            }
            
            // Add new stage if provided
            if (newStage && newStage !== MyClientDetails.currentClientData.stage) {
                updateData['Lead Stage'] = newStage;
                
                // Add callback date if Call Later
                if (newStage === 'Call Later' && MyClientDetails.updateCallLaterDate) {
                    const callbackDate = MyClientDetails.updateCallLaterDate.value;
                    if (callbackDate) {
                        updateData.Date = callbackDate; // Override any previously set date
                    }
                }
                
                // Add duration if Trial Attended
                if (newStage === 'Trial Attended') {
                    const hours = parseInt(MyClientDetails.updateDurationHours.value) || 0;
                    const minutes = parseInt(MyClientDetails.updateDurationMinutes.value) || 0;
                    const seconds = parseInt(MyClientDetails.updateDurationSeconds.value) || 0;
                    
                    // Format duration
                    const duration = `${hours}hr${minutes}min${seconds}sec`;
                    updateData.Duration = duration;
                }
            } else if (MyClientDetails.currentClientData.stage === 'Trial Attended' && 
                      MyClientDetails.updateTrialDurationContainer && 
                      MyClientDetails.updateTrialDurationContainer.style.display === 'block') {
                // Handle case where stage is already Trial Attended and duration is being updated
                const hours = parseInt(MyClientDetails.updateDurationHours.value) || 0;
                const minutes = parseInt(MyClientDetails.updateDurationMinutes.value) || 0;
                const seconds = parseInt(MyClientDetails.updateDurationSeconds.value) || 0;
                
                // Only update if duration has changed
                const newDuration = `${hours}hr${minutes}min${seconds}sec`;
                if (newDuration !== MyClientDetails.currentClientData.duration) {
                    updateData.Duration = newDuration;
                }
            }
            
            // Check if anything is being updated
            if (Object.keys(updateData).length <= 1) { // Only Id exists
                alert('No changes detected. Please make a change before updating.');
                if (MyClientDetails.updateClientButton) {
                    MyClientDetails.updateClientButton.disabled = false;
                    MyClientDetails.updateClientButton.textContent = 'Update Client';
                }
                return;
            }
            
            // Update the client record
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': MyClientDetails.API_TOKEN
                },
                body: JSON.stringify([updateData])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update client: ${response.statusText}`);
            }
            
            // Close modal
            if (MyClientDetails.updateClientModal) {
                MyClientDetails.updateClientModal.style.display = 'none';
            }
            
            // Refresh the client list
            const stage = MyClientDetails.clientFilterStage ? MyClientDetails.clientFilterStage.value : '';
            const date = MyClientDetails.clientFilterAll && MyClientDetails.clientFilterAll.checked ? 
                null : (MyClientDetails.clientFilterDate ? MyClientDetails.clientFilterDate.value : '');
            
            if (stage) {
                MyClientDetails.fetchClientsByStageAndDate(stage, date);
            }
            
            // Show success message
            alert('Client updated successfully');
            
        } catch (error) {
            console.error('Error updating client:', error);
            alert(`Error updating client: ${error.message}`);
        } finally {
            if (MyClientDetails.updateClientButton) {
                MyClientDetails.updateClientButton.disabled = false;
                MyClientDetails.updateClientButton.textContent = 'Update Client';
            }
        }
    };
    
    // Send data to n8n webhook
    MyClientDetails.sendToWebhook = async function(type, phone, agentCode, agentName, source = '', notes = '') {
        const webhookUrl = MyClientDetails.WEBHOOKS[type];
        
        if (!webhookUrl) {
            console.warn(`No webhook URL defined for type: ${type}`);
            return false;
        }
        
        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phone,
                    agent: agentCode,
                    agentName: agentName,
                    source: source,
                    notes: notes,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to send to webhook: ${response.statusText}`);
            }
            
            console.log(`Successfully sent to ${type} webhook`);
            return true;
        } catch (error) {
            console.error(`Error sending to ${type} webhook:`, error);
            throw error;
        }
    };
    
    // Transfer client to another agent
    MyClientDetails.transferClient = async function(clientId, phone, targetAgent, leadStage, selectedDate, notes) {
        const sourceAgent = localStorage.getItem('agentCode');
        const sourceAgentName = localStorage.getItem('agentName');
        
        if (!sourceAgent) {
            alert('Please login first');
            return;
        }
        
        // Show loading in modal
        if (MyClientDetails.transferClientButton) {
            MyClientDetails.transferClientButton.disabled = true;
            MyClientDetails.transferClientButton.textContent = 'Transferring...';
        }
        
        try {
            console.log("Starting transfer with values:", {
                clientId,
                phone,
                targetAgent,
                leadStage,
                selectedDate,
                notes
            });
            
            // 1. Get the source table ID (current agent)
            const sourceTableId = MyClientDetails.TABLE_IDS[sourceAgent];
            
            // 2. Get the target table ID (agent to transfer to)
            const targetTableId = MyClientDetails.TABLE_IDS[targetAgent];
            
            if (!sourceTableId || !targetTableId) {
                throw new Error('Invalid agent table IDs');
            }
            
            // 3. Update all instances of this phone in the main table
            await MyClientDetails.updateMainTableAgent(phone, targetAgent);
            
            // 4. Add the lead to the target agent's table
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            // Source for transfer (who transferred it)
            const transferSource = `Transfer from ${sourceAgentName || sourceAgent}`;
            
            // Combine notes with transfer note
            const combinedNotes = notes ? 
                `[Transfer Note: ${notes}]` : 
                '[Transferred from another agent]';
            
            const addResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${targetTableId}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': MyClientDetails.API_TOKEN
                },
                body: JSON.stringify({
                    Phone: phone,
                    Date: selectedDate,
                    Time: time,
                    Source: transferSource,
                    Notes: combinedNotes,
                    "Lead Stage": leadStage
                })
            });
            
            if (!addResponse.ok) {
                throw new Error(`Failed to add to target agent's table: ${addResponse.statusText}`);
            }
            
            // 5. Delete the lead from the source agent's table
            // 5. Delete the lead from the source agent's table
const deleteResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${sourceTableId}/records`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
        'xc-token': MyClientDetails.API_TOKEN
    },
    body: JSON.stringify([
        {
            "Id": clientId.toString()
        }
    ])
});

if (!deleteResponse.ok) {
    throw new Error(`Failed to delete from source agent's table: ${deleteResponse.statusText}`);
}
            
            // Close modal
            if (MyClientDetails.transferClientModal) {
                MyClientDetails.transferClientModal.style.display = 'none';
            }
            
            // Refresh the client list
            const stage = MyClientDetails.clientFilterStage ? MyClientDetails.clientFilterStage.value : '';
            const date = MyClientDetails.clientFilterAll && MyClientDetails.clientFilterAll.checked ? 
                null : (MyClientDetails.clientFilterDate ? MyClientDetails.clientFilterDate.value : '');
            
            if (stage) {
                MyClientDetails.fetchClientsByStageAndDate(stage, date);
            }
            
            // Show success message
            alert('Client transferred successfully');
            
        } catch (error) {
            console.error('Error transferring client:', error);
            alert(`Error transferring client: ${error.message}`);
        } finally {
            if (MyClientDetails.transferClientButton) {
                MyClientDetails.transferClientButton.disabled = false;
                MyClientDetails.transferClientButton.textContent = 'Transfer Client';
            }
        }
    };
    
    // Update all instances of a phone number in the main table with a new agent
    MyClientDetails.updateMainTableAgent = async function(phone, targetAgent) {
        try {
            // Main table ID
            const mainTableId = 'mxrl7syu0qe3xu3';
            
            // First, get all records with this phone number
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${mainTableId}/records?where=(Phone,eq,${phone})`, {
                method: 'GET',
                headers: {
                    'xc-token': MyClientDetails.API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch lead records: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.list || data.list.length === 0) {
                return; // No records to update
            }
            
            // Format target agent name for DB (lowercase, no spaces)
            const targetAgentName = targetAgent.toLowerCase().replace(' ', '');
            
            // Prepare update data for all records
            const updateData = data.list.map(record => ({
                Id: record.Id.toString(),
                Agent: targetAgentName
            }));
            
            // Update all records
            const updateResponse = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${mainTableId}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': MyClientDetails.API_TOKEN
                },
                body: JSON.stringify(updateData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Failed to update lead records: ${updateResponse.statusText}`);
            }
            
            return true;
        } catch (error) {
            console.error('Error updating main table agent:', error);
            throw error;
        }
    };
    
    // Helper function to format date
    MyClientDetails.formatDate = function(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };
    
    // Initialize component
    MyClientDetails.init = function() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            const container = document.querySelector('.my-client-details-container');
            if (container) container.style.display = 'none';
            return;
        }
        
        // Initialize WhatsApp templates
        MyClientDetails.initWhatsAppTemplates();
        
        console.log('My Client Details component initialized');
    };
    
    // Initialize on DOM content loaded
    MyClientDetails.init();
    
    // Expose to window for debugging - optional, can be removed in production
    window.MyClientDetails = MyClientDetails;
})();
</script>
        
        <div class="section-divider"></div>
        
        <!-- Check Individual Lead Section - Only visible after login -->
        <div id="checkIndividualLeadSection" class="crm-section" style="display: none;">
            <!-- Check Individual Lead Component will be inserted here -->


            <!-- Check Individual Lead Component -->
<div class="card check-individual-lead-container">
    <div class="card-header">
        <h2>Check Individual Lead</h2>
    </div>
    <div class="card-body">
        <p class="section-description">Search for a specific lead by phone number.</p>
        
        <div class="search-form">
            <div class="form-group">
                <label for="searchLeadPhone">Enter Phone Number:</label>
                <div class="search-input-container">
                    <input type="tel" id="searchLeadPhone" class="form-control" placeholder="Enter 10 digit phone number" pattern="[0-9]{10}" maxlength="10">
                    <button id="searchLeadButton" class="btn btn-primary">Search</button>
                </div>
                <small class="form-text">Enter 10 digit phone number without country code</small>
            </div>
        </div>
        
        <div id="leadSearchLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Searching for lead...</p>
        </div>
        
        <div id="leadSearchResults" class="lead-search-results" style="display: none;">
            <div class="results-header">
                <h3 id="leadSearchTitle">Lead Results</h3>
                <span id="leadSearchCount" class="results-count">0 records found</span>
            </div>
            
            <div id="leadSearchCardContainer" class="lead-search-card-container">
                <!-- Lead cards will be inserted here dynamically -->
            </div>
            
            <div id="noLeadFound" class="no-results" style="display: none;">
                <p>No lead found with this phone number in your records.</p>
            </div>
        </div>
        
        <!-- Update Lead Modal -->
        <div id="updateLeadModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Update Lead</h3>
                    <span id="closeLeadModal" class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="client-info-display">
                        <p><strong>Phone:</strong> <span id="updateLeadPhone"></span></p>
                        <p><strong>Current Stage:</strong> <span id="updateLeadCurrentStage"></span></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateLeadDate">Update Date:</label>
                        <input type="date" id="updateLeadDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="updateLeadStage">New Lead Stage:</label>
                        <select id="updateLeadStage" class="form-control">
                            <option value="" disabled selected>Select new stage</option>
                            <option value="WhatsApp">WhatsApp</option>
                            <option value="Transfer">Transfer</option>
                            <option value="App Pending">App Pending</option>
                            <option value="App Done">App Done</option>
                            <option value="Trial Enrolled">Trial Enrolled</option>
                            <option value="Trial Attended">Trial Attended</option>
                            <option value="Call Later">Call Later</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    
                    <!-- Trial Attended duration picker (hidden by default) -->
                    <div id="updateLeadDurationContainer" class="form-group" style="display: none;">
                        <label>Update Trial Duration:</label>
                        <div class="duration-picker">
                            <div class="duration-field">
                                <input type="number" id="updateLeadDurationHours" class="form-control" min="0" max="23" value="0">
                                <label>Hours</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="updateLeadDurationMinutes" class="form-control" min="0" max="59" value="0">
                                <label>Minutes</label>
                            </div>
                            <div class="duration-field">
                                <input type="number" id="updateLeadDurationSeconds" class="form-control" min="0" max="59" value="0">
                                <label>Seconds</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Call Later date picker (hidden by default) -->
                    <div id="updateLeadCallLaterDateContainer" class="form-group" style="display: none;">
                        <label for="updateLeadCallLaterDate">Select New Call Back Date:</label>
                        <input type="date" id="updateLeadCallLaterDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="updateLeadNotes">Update Notes:</label>
                        <textarea id="updateLeadNotes" class="form-control" rows="3" placeholder="Add or update notes..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button id="updateLeadButton" class="btn btn-primary btn-block">Update Lead</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Check Individual Lead specific styles */
.search-input-container {
    display: flex;
    gap: 0.5rem;
}

.search-input-container .form-control {
    flex: 1;
}

.form-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: var(--gray-color);
}

.lead-search-results {
    margin-top: 2rem;
}

.lead-search-card-container {
    margin: 1rem 0;
    max-height: 500px;
    overflow-y: auto;
}

.client-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
}

.client-card-number {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: var(--light-gray);
    color: var(--gray-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.results-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.results-count {
    color: var(--gray-color);
    font-size: 0.9rem;
}

.no-results {
    text-align: center;
    padding: 2rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
}

/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    width: 90%;
    max-width: 500px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: var(--primary-color);
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.close-modal {
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.client-info-display {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
}

.client-info-display p {
    margin: 0.25rem 0;
}

.modal-footer {
    padding: 1rem 1.5rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
}

.modal-footer .btn {
    margin-top: 0;
}

@media (max-width: 576px) {
    .search-input-container {
        flex-direction: column;
    }
    
    .search-input-container .btn {
        width: 100%;
    }
    
    .modal-content {
        width: 95%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // API Token
    const API_TOKEN = 'UqtPUnEsD3OQeHwlwb7IC4BFpCxG6AY3J4evDXSd';
    
    // Table IDs
    const TABLE_IDS = {
        'Agent 1': 'mlxuttgldb0b1rv',
        'Agent 2': 'mtqgkw2m8nyit45',
        'Agent 3': 'mjj52spsxtv6lz0',
        'Agent 4': 'mbnc4xkhtfw00yn',
        'Agent 5': 'm5jyr5lom8ypoln',
        'Agent 6': 'mrzi0hk8yyyw7th',
        'Agent 7': 'mn0ym8rn1lh0tgz',
        'Agent 8': 'm13ewz7oin2gm60',
        'Agent 9': 'm2e1omymw9h0juu',
        'Agent 10': 'm72etgmfw9wkdj2',
        'Agent 11': 'mxpub6h9ypwkuku',
        'Agent 12': 'mdbped83zgd7w37'
    };
    
    // DOM Elements
    const searchLeadPhone = document.getElementById('searchLeadPhone');
    const searchLeadButton = document.getElementById('searchLeadButton');
    const leadSearchLoading = document.getElementById('leadSearchLoading');
    const leadSearchResults = document.getElementById('leadSearchResults');
    const leadSearchTitle = document.getElementById('leadSearchTitle');
    const leadSearchCount = document.getElementById('leadSearchCount');
    const leadSearchCardContainer = document.getElementById('leadSearchCardContainer');
    const noLeadFound = document.getElementById('noLeadFound');
    
    // Modal Elements
    const updateLeadModal = document.getElementById('updateLeadModal');
    const closeLeadModal = document.getElementById('closeLeadModal');
    const updateLeadPhone = document.getElementById('updateLeadPhone');
    const updateLeadCurrentStage = document.getElementById('updateLeadCurrentStage');
    const updateLeadDate = document.getElementById('updateLeadDate');
    const updateLeadStage = document.getElementById('updateLeadStage');
    const updateLeadDurationContainer = document.getElementById('updateLeadDurationContainer');
    const updateLeadDurationHours = document.getElementById('updateLeadDurationHours');
    const updateLeadDurationMinutes = document.getElementById('updateLeadDurationMinutes');
    const updateLeadDurationSeconds = document.getElementById('updateLeadDurationSeconds');
    const updateLeadCallLaterDateContainer = document.getElementById('updateLeadCallLaterDateContainer');
    const updateLeadCallLaterDate = document.getElementById('updateLeadCallLaterDate');
    const updateLeadNotes = document.getElementById('updateLeadNotes');
    const updateLeadButton = document.getElementById('updateLeadButton');
    
    // Set today as min date for call later
    const today = new Date().toISOString().split('T')[0];
    updateLeadCallLaterDate.min = today;
    updateLeadDate.min = "2023-01-01"; // Allow past dates
    
    // Track current lead for updates
    let currentLeadId = null;
    let currentLeadData = null;
    
    // Check for active lead phone from Lead Management
    const savedLead = localStorage.getItem('currentLead');
    if (savedLead) {
        try {
            const currentLead = JSON.parse(savedLead);
            if (currentLead && currentLead.Phone) {
                searchLeadPhone.value = currentLead.Phone;
            }
        } catch (e) {
            console.error('Error parsing saved lead:', e);
        }
    }
    
    // Event Listeners
    
    // Search lead button click
    searchLeadButton.addEventListener('click', function() {
        const phone = searchLeadPhone.value;
        
        if (!phone || phone.length !== 10 || !/^\d+$/.test(phone)) {
            alert('Please enter a valid 10 digit phone number');
            return;
        }
        
        // Search for lead
        searchLeadByPhone(phone);
    });
    
    // Enter key in phone input
    searchLeadPhone.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchLeadButton.click();
        }
    });
    
    // Close modal button
    closeLeadModal.addEventListener('click', function() {
        updateLeadModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === updateLeadModal) {
            updateLeadModal.style.display = 'none';
        }
    });
    
    // Toggle additional fields based on selected stage in update modal
    updateLeadStage.addEventListener('change', function() {
        const selectedStage = this.value;
        
        // Toggle trial duration container
        if (selectedStage === 'Trial Attended') {
            updateLeadDurationContainer.style.display = 'block';
        } else {
            updateLeadDurationContainer.style.display = 'none';
        }
        
        // Toggle call later date container
        if (selectedStage === 'Call Later') {
            updateLeadCallLaterDateContainer.style.display = 'block';
        } else {
            updateLeadCallLaterDateContainer.style.display = 'none';
        }
    });
    
    // Update lead button click
    updateLeadButton.addEventListener('click', function() {
        if (!currentLeadId) {
            alert('No lead selected for update');
            return;
        }
        
        const phone = updateLeadPhone.textContent;
        const newStage = updateLeadStage.value;
        const notes = updateLeadNotes.value;
        const newDate = updateLeadDate.value;
        
        // Check if any update is provided
        if (!newStage && !newDate && (!notes || notes.trim() === '')) {
            alert('Please select a new stage, date, or add notes for update');
            return;
        }
        
        // Additional validation for specific stages
        if (newStage === 'Call Later' && !updateLeadCallLaterDate.value) {
            alert('Please select a call back date');
            return;
        }
        
        // Process the update
        updateLead(currentLeadId, phone, newStage, notes, newDate);
    });
    
    // Search for lead by phone number
    async function searchLeadByPhone(phone) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        // Get agent's table ID
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId) {
            alert(`Table ID not found for ${agentCode}`);
            return;
        }
        
        // Show loading
        leadSearchLoading.style.display = 'flex';
        leadSearchResults.style.display = 'none';
        leadSearchCardContainer.innerHTML = '';
        noLeadFound.style.display = 'none';
        
        try {
            // Construct the query URL to search by phone
            const queryUrl = `https://nocodb.tsblive.in/api/v2/tables/${tableId}/records?where=(Phone,eq,${phone})&sort=-Id`;
            
            const response = await fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'xc-token': API_TOKEN
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to search lead: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Display results
            displayLeadSearchResults(data.list, phone);
            
        } catch (error) {
            console.error('Error searching lead:', error);
            leadSearchLoading.style.display = 'none';
            alert(`Error searching lead: ${error.message}`);
        }
    }
    
    // Display lead search results
    function displayLeadSearchResults(leads, phone) {
        // Hide loading
        leadSearchLoading.style.display = 'none';
        
        // Update results title and count
        leadSearchTitle.textContent = `Results for: ${phone}`;
        
        if (!leads || leads.length === 0) {
            // Show no results
            noLeadFound.style.display = 'block';
            leadSearchCount.textContent = '0 records found';
            leadSearchResults.style.display = 'block';
            return;
        }
        
        // Update count
        leadSearchCount.textContent = `${leads.length} records found`;
        
        // Clear container
        leadSearchCardContainer.innerHTML = '';
        
        // Add each lead as a card
        leads.forEach((lead, index) => {
            const card = document.createElement('div');
            card.className = 'client-card';
            card.style.position = 'relative';
            
            // Add serial number
            const serialNumber = document.createElement('div');
            serialNumber.className = 'client-card-number';
            serialNumber.textContent = index + 1;
            card.appendChild(serialNumber);
            
            // Convert stage class (lowercase, replace spaces with hyphens)
            const stageClass = `stage-${(lead['Lead Stage'] || '').toLowerCase().replace(/\s+/g, '-')}`;
            
            card.innerHTML += `
                <div class="client-card-header">
                    <h3 class="client-card-title">${lead.Phone || 'No Phone'}</h3>
                    <span class="client-card-stage ${stageClass}">${lead['Lead Stage'] || 'Unknown'}</span>
                </div>
                <div class="client-card-content">
                    <p><span class="client-card-label">Date:</span> ${lead.Date || 'N/A'}</p>
                    <p><span class="client-card-label">Source:</span> ${lead.Source || 'N/A'}</p>
                    ${lead.Duration ? `<p><span class="client-card-label">Duration:</span> ${lead.Duration}</p>` : ''}
                    <p><span class="client-card-label">Notes:</span> ${lead.Notes || 'No notes'}</p>
                </div>
                <div class="client-card-actions">
                    <a href="tel:${lead.Phone}" class="btn btn-call">Call</a>
                    <a href="https://wa.me/91${lead.Phone}" class="btn btn-whatsapp">WhatsApp</a>
                    <button class="btn btn-primary update-lead-btn" 
                            data-phone="${lead.Phone}"
                            data-stage="${lead['Lead Stage'] || ''}"
                            data-notes="${lead.Notes || ''}"
                            data-id="${lead.Id}"
                            data-date="${lead.Date || today}"
                            data-duration="${lead.Duration || ''}">
                        Update
                    </button>
                </div>
            `;
            
            leadSearchCardContainer.appendChild(card);
        });
        
        // Add event listeners to update buttons
        const updateButtons = document.querySelectorAll('.update-lead-btn');
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const phone = this.getAttribute('data-phone');
                const stage = this.getAttribute('data-stage');
                const notes = this.getAttribute('data-notes');
                const id = this.getAttribute('data-id');
                const date = this.getAttribute('data-date');
                const duration = this.getAttribute('data-duration');
                
                openUpdateLeadModal(phone, stage, notes, id, date, duration);
            });
        });
        
        // Show results
        leadSearchResults.style.display = 'block';
    }
    
    // Open update lead modal
    function openUpdateLeadModal(phone, stage, notes, id, date, duration) {
        // Set values in modal
        updateLeadPhone.textContent = phone;
        updateLeadCurrentStage.textContent = stage;
        updateLeadNotes.value = notes;
        updateLeadDate.value = date || today;
        
        // Store current lead data
        currentLeadId = id;
        currentLeadData = {
            phone: phone,
            stage: stage,
            notes: notes,
            date: date,
            duration: duration
        };
        
        // Reset selections
        updateLeadStage.value = '';
        updateLeadDurationHours.value = '0';
        updateLeadDurationMinutes.value = '0';
        updateLeadDurationSeconds.value = '0';
        updateLeadCallLaterDate.value = '';
        
        // Hide conditional containers
        updateLeadDurationContainer.style.display = 'none';
        updateLeadCallLaterDateContainer.style.display = 'none';
        
        // Parse duration if available
        if (duration) {
            const durationMatch = duration.match(/(\d+)hr(\d+)min(\d+)sec/);
            if (durationMatch) {
                updateLeadDurationHours.value = durationMatch[1];
                updateLeadDurationMinutes.value = durationMatch[2];
                updateLeadDurationSeconds.value = durationMatch[3];
            }
        }
        
        // Show modal
        updateLeadModal.style.display = 'block';
    }
    
    // Update lead
    async function updateLead(leadId, phone, newStage, notes, newDate) {
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            alert('Please login first');
            return;
        }
        
        const tableId = TABLE_IDS[agentCode];
        
        if (!tableId || !leadId) {
            alert('Missing table ID or lead ID');
            return;
        }
        
        // Prepare update data
        const updateData = {
            Id: leadId
        };
        
        // Add date if changed
        if (newDate && newDate !== currentLeadData.date) {
            updateData.Date = newDate;
        }
        
        // Add notes if provided or changed
        if (notes && notes !== currentLeadData.notes) {
            updateData.Notes = notes;
        }
        
        // Add new stage if provided
        if (newStage && newStage !== currentLeadData.stage) {
            updateData['Lead Stage'] = newStage;
            
            // Add callback date if Call Later
            if (newStage === 'Call Later') {
                const callbackDate = updateLeadCallLaterDate.value;
                if (!callbackDate) {
                    alert('Please select a call back date');
                    return;
                }
                updateData.Date = callbackDate; // Override any previously set date
            }
            
            // Add duration if Trial Attended
            if (newStage === 'Trial Attended') {
                const hours = parseInt(updateLeadDurationHours.value) || 0;
                const minutes = parseInt(updateLeadDurationMinutes.value) || 0;
                const seconds = parseInt(updateLeadDurationSeconds.value) || 0;
                
                // Format duration
                const duration = `${hours}hr${minutes}min${seconds}sec`;
                updateData.Duration = duration;
            }
        }
        
        // Check if anything is being updated
        if (Object.keys(updateData).length <= 1) { // Only Id exists
            alert('No changes detected. Please make a change before updating.');
            return;
        }
        
        try {
            // Show loading in modal
            updateLeadButton.disabled = true;
            updateLeadButton.textContent = 'Updating...';
            
            const response = await fetch(`https://nocodb.tsblive.in/api/v2/tables/${tableId}/records`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'xc-token': API_TOKEN
                },
                body: JSON.stringify([updateData])
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update lead: ${response.statusText}`);
            }
            
            // Close modal
            updateLeadModal.style.display = 'none';
            
            // Refresh the search results
            searchLeadByPhone(phone);
            
            // Show success message
            alert('Lead updated successfully');
            
        } catch (error) {
            console.error('Error updating lead:', error);
            alert(`Error updating lead: ${error.message}`);
        } finally {
            updateLeadButton.disabled = false;
            updateLeadButton.textContent = 'Update Lead';
        }
    }
    
    // Initialize component
    function initCheckIndividualLead() {
        // Check if agent is logged in
        const agentCode = localStorage.getItem('agentCode');
        
        if (!agentCode) {
            document.querySelector('.check-individual-lead-container').style.display = 'none';
        }
    }
    
    // Initialize on DOM content loaded
    initCheckIndividualLead();
});
</script>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const agentDisplay = document.querySelector('.agent-display');
            const navLogoutBtn = document.getElementById('navLogoutBtn');
            const allSections = document.querySelectorAll('.crm-section');
            
            // Check if agent is logged in
            function checkAgentLogin() {
                const agentCode = localStorage.getItem('agentCode');
                const agentName = localStorage.getItem('agentName');
                
                if (agentCode && agentName) {
                    // Display agent info in navbar
                    document.querySelectorAll('.agent-code-display').forEach(el => {
                        el.textContent = agentCode;
                    });
                    
                    document.querySelectorAll('.agent-name-display').forEach(el => {
                        el.textContent = agentName;
                    });
                    
                    // Show agent display and logout button
                    agentDisplay.style.display = 'block';
                    navLogoutBtn.style.display = 'block';
                    
                    // Hide agent selection, show all other sections
                    document.getElementById('agentSelectionSection').style.display = 'none';
                    
                    const loggedInSections = [
                        'dashboardSection',
                        'leadManagementSection',
                        'notMyLeadSection',
                        'addNewClientSection',
                        'myClientDetailsSection',
                        'checkIndividualLeadSection'
                    ];
                    
                    loggedInSections.forEach(id => {
                        const section = document.getElementById(id);
                        if (section) {
                            section.style.display = 'block';
                        }
                    });
                } else {
                    // Hide agent display and logout button
                    agentDisplay.style.display = 'none';
                    navLogoutBtn.style.display = 'none';
                    
                    // Show only agent selection section
                    allSections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    document.getElementById('agentSelectionSection').style.display = 'block';
                }
            }
            
            // Logout button click
            navLogoutBtn.addEventListener('click', function() {
                if (window.logoutAgent) {
                    window.logoutAgent();
                } else {
                    // Keep current lead info when logging out
                    const currentLead = localStorage.getItem('currentLead');
                    const leadHistory = localStorage.getItem('leadHistory');
                    
                    // Clear agent info
                    const agentCode = localStorage.getItem('agentCode');
                    localStorage.removeItem('agentCode');
                    localStorage.removeItem('agentName');
                    localStorage.removeItem('agentNumber');
                    
                    // Reload the page
                    window.location.reload();
                }
            });
            
            // Listen for agent login event
            document.addEventListener('agentLoggedIn', function() {
                checkAgentLogin();
            });
            
            // Check on page load
            checkAgentLogin();
            
            // Global logout function
            window.logoutAgent = function() {
                // Keep current lead info when logging out
                const currentLead = localStorage.getItem('currentLead');
                const leadHistory = localStorage.getItem('leadHistory');
                
                // Clear agent info
                localStorage.removeItem('agentCode');
                localStorage.removeItem('agentName');
                localStorage.removeItem('agentNumber');
                
                // Reload the page
                window.location.reload();
            };
        });
    </script>
</body>
</html>
